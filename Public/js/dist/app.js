var note=angular.module("M_NOTE",["ui.router","ipCookie"]);note.config(["$locationProvider","$urlRouterProvider","$compileProvider",function(e,t,i){t.otherwise(""),i.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|javascript):/)}]),note.config(["$httpProvider",function(e){e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",e.defaults.headers.common["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var t=function(e){var i,o,l,c,a,n,r,s="";for(i in e)if(o=e[i],o instanceof Array)for(r=0;r<o.length;++r)a=o[r],l=i+"["+r+"]",n={},n[l]=a,s+=t(n)+"&";else if(o instanceof Object)for(c in o)a=o[c],l=i+"["+c+"]",n={},n[l]=a,s+=t(n)+"&";else void 0!==o&&null!==o&&(s+=encodeURIComponent(i)+"="+encodeURIComponent(o)+"&");return s.length?s.substr(0,s.length-1):s};e.defaults.transformRequest=[function(e){return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e}]}]);var site_prefix="http://localhost/note2/";note.controller("c_index",function(e,t,i,o,l,c,a){t.$on("$locationChangeStart",function(e){a("is_logined")||(console.log(arguments),console.log(arguments[1].split("#")[1]),"/login"!=arguments[1].split("#")[1]&&"/register"!=arguments[1].split("#")[1]&&(i.go("login"),hMessage("请登录后再操作！")))}),i.go("home")}),note.controller("c_nav",function(e,t,i,o,l){e.current_tab="home",e.switchTab=function(i){e.current_tab=i,t.go(i)},l("is_logined")?(i.login_register_show=!1,i.user_show=!0,i.username_text='<i class="uk-icon-user"></i> '+l("username")):(i.login_register_show=!0,i.user_show=!1,i.username_text="")}),note.controller("c_login",function(e,t,i,o,l){setTitle("随手记-登陆"),e.username=e.password="",e.login=function(){if(e.username.length<1||e.password.length<1)return void hMessage("用户名或密码不能为空！",2e3);if(e.password.length>=1&&e.password.length<6)return void hMessage("请输入6位以上的密码！",2e3);var c={username:e.username,password:e.password};l.login(c).success(function(l){0===l.error?(hMessage("登陆成功！",1500),i.login_register_show=!1,i.user_show=!0,i.user={},i.user.is_logined=!0,console.log("已登陆"),o("is_logined",1),o("username",e.username),i.user.name=e.username,i.username_text='<i class="uk-icon-user"></i> '+e.username,i.user.email="819537918@qq.com",i.user.id=1e3,i.user.avatar="https://dn-lanbaidiao.qbox.me/avatar_1000_a645761e1fc399f5be08308eacead7ce?imageView2/1/w/80/h/80",setTimeout(function(){t.go("home")},1500)):2===l.error?hMessage("该用户不存在！",1500):hMessage(l.msg,2e3)}).error(function(e,t){console.log(e),console.log(t)})}}),note.controller("c_register",function(e,t,i){setTitle("随手记-注册"),e.username=e.email=e.password=e.password_confirm="",e.register=function(){if(console.log(e.username+","+e.email+","+e.password+","+e.password_confirm),e.username.length<1)return void hMessage("用户名不能为空！",2e3);if(!usernameVerify(e.username))return void hMessage("用户名只能以英文字母或中文开头,包含数字，下划线，字母，中文！",3e3);if(e.email.length<1)return void hMessage("邮箱不能为空！",2e3);if(!emailVerify(e.email))return void hMessage("请输入正确的邮箱格式！",2e3);if(checkEmpty(e.password))return void hMessage("密码不能为空！",2e3);if(e.password.length>1&&e.password.length<6)return void hMessage("请输入6位以上的密码！",2e3);if(e.password!==e.password_confirm)return void hMessage("两次输入的密码不一致！",2e3);$("#register-btn").html("注册中..."),$("#register-btn").attr("disabled","disabled");var o={username:e.username,email:e.email,password:e.password,password_confirm:e.password_confirm};i.register(o).success(function(e){0===e.error?(hMessage("注册成功，请登陆！",2e3),t.go("login")):hMessage(e.msg,2e3),$("#register-btn").html("注册"),$("#register-btn").attr("disabled",!1)})}}),note.controller("c_bill",function(e,t,i){setTitle("随手记-记账"),t.bill_operation_trigger=0,t.current_operation="add_bill",t.account_items=t.child_accounts=t.bill_category_items=t.child_bill_categories={},i.go("today_bills"),t.templates={},t.templates.bill=templates_path+"/bill",t.templates.bill_add=t.templates.bill+"/bill_add_outcome.html",t.templates.bill_view=t.templates.bill+"/bill_details.html",t.templates.add_category=t.templates.bill+"/add_category.html",t.templates.add_account=t.templates.bill+"/add_account.html",e.current_bill_tab="today_bills",e.switchBillTab=function(t){e.current_bill_tab=t,i.go(t)}}),note.controller("c_today_bills",function(e,t,i,o,l){t.bill_tip_show=!0,t.bill_tip="今天还没有账单信息，快去记一笔吧！",l.getTodayBills().success(function(e){0===e.error?(t.bills=e.bills,t.bill_tip_show=!1):2===e.error?(t.bills={},t.bill_tip_show=!0):hMessage(e.msg)}).error(function(e,t){console.log(e)}),e.vAddBill=function(){t.templates.bill_add=t.templates.bill+"/bill_add_outcome.html",t.current_operation="add_bill",t.bill_operation_trigger=0==t.bill_operation_trigger?1:0;var e=UIkit.modal("#add-bill-modal");e.show()},e.showBillDetail=function(e){t.current_bill=t.bills[e];var i=UIkit.modal("#bill-detail-modal");i.show()}}),note.controller("c_bill_add",function(e,t,i,o,l,c,a){e.bill_category={},e.current_bill_view=t.previous_view="outcome",e.bill={},e.bill.time={},e.$watch("bill.date",function(t,i){e.hours=[],e.minutes=[];var o=(new Date).getDate(),l=new Date(t).getDate();if(console.log("bill_date:"+l),o==l){for(var c=0;c<parseInt((new Date).getHours())+1;c++)e.hours.push(c);for(var c=0;c<parseInt((new Date).getMinutes())+1;c++)e.minutes.push(c)}else{for(var c=0;24>c;c++)e.hours.push(c);for(var c=0;60>c;c++)e.minutes.push(c)}e.bill.time.hour=parseInt((new Date).getHours()),e.bill.time.minute=parseInt((new Date).getMinutes())}),a.getAccounts().success(function(i){console.log(i),t.account_items=i.account_items,t.child_accounts=t.account_items[0].child_accounts,e.bill.account=t.account_items[0].account_id,e.bill.child_account=t.account_items[0].child_accounts[0].child_account_id}),t.$watch("bill_operation_trigger",function(i,o){if("modify_bill"==t.current_operation){console.log("触发器被触发了！"),console.log("newValue:"+i+",oldValue:"+o),console.log("当前是修改操作"),e.bill_type=1==t.current_bill.bill_type?1:2,e.bill_type_text=1==t.current_bill.bill_type?"记账-支出":"记账-收入",console.log("bill_type:"+e.bill_type);var l=1==e.bill_type?"outcome":"income";"outcome"==l?c.getCategoryInfo(1).success(function(e){console.log(e),t.bill_category_items=e.bill_category_items;for(var i=0;i<t.bill_category_items.length&&t.bill_category_items[i].bill_category_id!=t.current_bill.bill_category_id;i++);t.child_bill_categories=t.bill_category_items[i].child_bill_categories}):c.getCategoryInfo(2).success(function(e){console.log(e),t.bill_category_items=e.bill_category_items;for(var i=0;i<t.bill_category_items.length&&t.bill_category_items[i].bill_category_id!=t.current_bill.bill_category_id;i++);t.child_bill_categories=t.bill_category_items[i].child_bill_categories}),e.bill.category=t.current_bill.bill_category_id,e.bill.child_category=t.current_bill.child_bill_category_id,console.log("category:"+e.bill.category+",child_category:"+e.bill.child_category),e.hours=[],e.minutes=[];for(var a=0;24>a;a++)e.hours.push(a);for(var a=0;60>a;a++)e.minutes.push(a);e.bill.date=t.current_bill.bill_time.split(" ")[0],e.bill.time.hour=parseInt(t.current_bill.bill_time.split(" ")[1].split(":")[0]),e.bill.time.minute=parseInt(t.current_bill.bill_time.split(" ")[1].split(":")[1]);for(var a=0;a<t.account_items.length&&t.account_items[a].account_id!=t.current_bill.account_id;a++);t.child_accounts=t.account_items[a].child_accounts,e.bill.account=t.current_bill.account_id,e.bill.child_account=t.current_bill.child_account_id,e.bill.location=t.current_bill.bill_location,e.bill.sum=parseFloat(t.current_bill.bill_sum),e.bill.remarks=t.current_bill.bill_remarks}else{console.log("当前是新增操作"),e.bill_type=1,e.bill_type_text="记账-支出",c.getCategoryInfo(1).success(function(i){console.log(i),t.bill_category_items=i.bill_category_items,t.child_bill_categories=t.bill_category_items[0].child_bill_categories,e.bill.category=t.bill_category_items[0].bill_category_id,e.bill.child_category=t.bill_category_items[0].child_bill_categories[0].child_bill_category_id});var n=new Date;e.bill.date=n.getFullYear()+"-"+(parseInt(n.getMonth())+1)+"-"+n.getDate(),e.bill.time.hour=parseInt(n.getHours()),e.bill.time.minute=parseInt(n.getMinutes()),e.hours=[],e.minutes=[];for(var a=0;a<parseInt(e.bill.time.hour)+1;a++)e.hours.push(a);console.log(e.hours);for(var a=0;a<parseInt(e.bill.time.minute)+1;a++)e.minutes.push(a);e.bill.location=e.bill.sum=e.bill.remarks=null}}),e.billAccountTypeChange=function(){for(var i=0,o=0;o<t.account_items.length;o++)if(e.bill.account==t.account_items[o].account_id){i=o;break}console.log("index:"+i),t.child_accounts=t.account_items[i].child_accounts,e.bill.child_account=t.child_accounts[0].child_account_id},e.billCategoryTypeChange=function(){for(var i=0,o=0;o<t.bill_category_items.length;o++)if(e.bill.category==t.bill_category_items[o].bill_category_id){i=o;break}console.log("index:"+i),t.child_bill_categories=t.bill_category_items[i].child_bill_categories,e.bill.child_category=t.child_bill_categories[0].child_bill_category_id},e.location_options_show=!1,e.add_bill_modal_click=function(){e.location_options_show=!1};var n="http://api.map.baidu.com/location/ip?ak="+baidu_ak+"&callback=JSON_CALLBACK",r=131;o.jsonp(n).success(function(e){r=e.content.address_detail.city_code}),e.location_options=[];var s="http://api.map.baidu.com/place/v2/suggestion";e.locationInputChange=function(){var t=s+"?query="+e.bill.location+"&region="+r+"&ak="+baidu_ak+"&output=json&callback=JSON_CALLBACK";o.jsonp(t).success(function(t){0==t.status?(e.location_options_show=!0,e.location_options=t.result):console.log("获取位置列表失败！")})},e.selectLocation=function(t){e.bill.location=t,e.location_options_show=!1},e.addBill=function(){var i={bill_type:e.bill_type,bill_category_id:e.bill.child_category,bill_account_id:e.bill.child_account,bill_time:e.bill.date+" "+e.bill.time.hour+":"+e.bill.time.minute,bill_location:e.bill.location,bill_sum:e.bill.sum,bill_remarks:e.bill.remarks};return e.bill.sum<0?void hMessage("金额不能为负！"):(console.log(i),void c.add(i).success(function(e){if(console.log(e),0===e.error){var i=UIkit.modal("#add-bill-modal");i.isActive()&&i.hide(),hMessage("账单添加成功！",2e3),c.getBillById(e.bill.bill_id).success(function(e){0===e.error?t.bills.push(e.bill):hMessage(e.msg)})}else hMessage(e.msg,2e3)}))},e.modifyBill=function(){if("modify_bill"==t.current_operation){var i={bill_id:t.current_bill.bill_id,bill_type:e.bill_type,bill_category_id:e.bill.child_category,bill_account_id:e.bill.child_account,bill_time:e.bill.date+" "+e.bill.time.hour+":"+e.bill.time.minute,bill_location:e.bill.location,bill_sum:e.bill.sum,bill_remarks:e.bill.remarks};if(e.bill.sum<0)return void hMessage("金额不能为负！");c.modify(i).success(function(e){if(console.log(e),0===e.error){var i=UIkit.modal("#add-bill-modal");i.hide(),hMessage("账单修改成功！",2e3);for(var o=0;o<t.bills.length;o++)if(t.bills[o].bill_id==t.current_bill.bill_id){c.getBillById(t.current_bill.bill_id).success(function(e){0===e.error?t.bills[o]=e.bill:hMessage(e.msg)});break}}else hMessage(e.msg,2e3)})}},e.bill_type_switch_tip_show=!1,e.switchBillType=function(){"modify_bill"==t.current_operation&&(e.bill_type_switch_tip_show=!0,e.bill_type_switch_tip="切换类型后账单<b>类别</b>可能需要修改！",l(function(){e.bill_type_switch_tip_show=!1},4e3)),t.child_accounts=t.account_items[0].child_accounts,e.bill.account=t.account_items[0].account_id,e.bill.child_account=t.child_accounts[0].child_account_id,"outcome"==e.current_bill_view?(c.getCategoryInfo(2).success(function(i){console.log(i),t.bill_category_items=i.bill_category_items,t.child_bill_categories=t.bill_category_items[0].child_bill_categories,e.bill.category=t.bill_category_items[0].bill_category_id,e.bill.child_category=t.bill_category_items[0].child_bill_categories[0].child_bill_category_id}),e.bill_type=2,t.templates.bill_add=t.templates.bill+"/bill_add_income.html",e.current_bill_view=t.previous_view="income",e.bill_type_text="记账-收入"):(c.getCategoryInfo(1).success(function(i){console.log(i),t.bill_category_items=i.bill_category_items,t.child_bill_categories=t.bill_category_items[0].child_bill_categories,e.bill.category=t.bill_category_items[0].bill_category_id,e.bill.child_category=t.bill_category_items[0].child_bill_categories[0].child_bill_category_id}),e.bill_type=1,t.templates.bill_add=t.templates.bill+"/bill_add_outcome.html",e.current_bill_view=t.previous_view="outcome",e.bill_type_text="记账-支出")},e.backToDetail=function(){var e=UIkit.modal("#bill-detail-modal");e.show(),t.templates.bill_add=t.templates.bill+"/bill_details.html"},e.vAddCategory=function(e){t.previous_view=e,t.templates.bill_add=t.templates.add_category},e.vAddAccount=function(){t.templates.bill_add=t.templates.add_account}}),note.controller("c_add_bill_category",function(e,t,i,o,l){e.ifAddSelfCategory=!1,e.add_self_category_btn_icon='<i class="uk-icon-toggle-off uk-icon-medium"></i>',e.add_category_title="outcome"==t.previous_view?"支出":"收入",e.bill_category.bill_category=t.bill_category_items[0].bill_category_id,e.switchAddSelfCategory=function(){e.ifAddSelfCategory=e.ifAddSelfCategory?!1:!0,e.ifAddSelfCategory?(e.bill_category.bill_category="",e.add_self_category_btn_icon='<i class="uk-icon-toggle-on uk-icon-medium"></i>'):(e.bill_category.bill_category=t.bill_category_items[0].bill_category_id,e.add_self_category_btn_icon='<i class="uk-icon-toggle-off uk-icon-medium"></i>')},e.addCategory=function(){var i="outcome"==t.previous_view?1:2,o=e.ifAddSelfCategory?1:0,c={is_self_defined:o,bill_type:i,bill_category:e.bill_category.bill_category,child_bill_category:e.bill_category.child_bill_category};l.addCategory(c).success(function(i){console.log(i),0===i.error?(hMessage("添加分类成功！",2e3),t.bill_category_items="outcome"==t.previous_view?l.getCategoryInfo(1).success(function(i){console.log(i),t.bill_category_items=i.bill_category_items,t.child_bill_categories=t.bill_category_items[0].child_bill_categories,e.bill_category.bill_category=t.bill_category_items[0].bill_category_id,e.bill.category=t.bill_category_items[0].bill_category_id,e.bill.child_category=t.bill_category_items[0].child_bill_categories[0].child_bill_category_id}):l.getCategoryInfo(2).success(function(i){console.log(i),t.bill_category_items=i.bill_category_items,t.child_bill_categories=t.bill_category_items[0].child_bill_categories,e.bill_category.bill_category=t.bill_category_items[0].bill_category_id,e.bill.category=t.bill_category_items[0].bill_category_id,e.bill.child_category=t.bill_category_items[0].child_bill_categories[0].child_bill_category_id})):hMessage(i.msg,2e3)})},e.backward=function(){t.templates.bill_add=t.templates.bill+"/bill_add_"+t.previous_view+".html"}}),note.controller("c_add_account",function(e,t,i,o,l){e.added_account=t.account_items[0].account_id,e.added_child_account_name="",e.added_child_account_balance=e.added_child_account_remarks="",e.add_self_account_btn_icon='<i class="uk-icon-toggle-off uk-icon-medium"></i>',e.ifAddSelfAccount=!1,e.switchSelfAccount=function(){e.ifAddSelfAccount=e.ifAddSelfAccount?!1:!0,e.ifAddSelfAccount?(e.added_account="",e.add_self_account_btn_icon='<i class="uk-icon-toggle-on uk-icon-medium"></i>'):(e.added_account=t.account_items[0].account_id,e.add_self_account_btn_icon='<i class="uk-icon-toggle-off uk-icon-medium"></i>')},e.addAccount=function(){var i=e.ifAddSelfAccount?1:0,c={is_self_defined:i,account:e.added_account,child_account_name:e.added_child_account_name,child_account_balance:e.added_child_account_balance,child_account_remarks:e.added_child_account_remarks};console.log(c),o({method:"POST",url:home_path+"/Account/add_account.html",data:{is_self_defined:i,account:e.added_account,child_account_name:e.added_child_account_name,child_account_balance:e.added_child_account_balance,child_account_remarks:e.added_child_account_remarks}}).success(function(i){0===i.error&&(l.getAccounts().success(function(i){t.account_items=i.account_items,t.child_accounts=t.account_items[0].child_accounts,e.added_account=t.account_items[0].account_id,e.bill.account=t.account_items[0].account_id,e.bill.child_account=t.account_items[0].child_accounts[0].child_account_id}),hMessage("添加成功！"))})},e.backward=function(){t.templates.bill_add=t.templates.bill+"/bill_add_"+t.previous_view+".html"}}),note.controller("c_bill_details",function(e,t,i,o,l){e.deleteBill=function(){var e=null==arguments[0]?t.current_bill.bill_id:arguments[0];confirm("你确定要删除该账单["+e+"]？本操作不可撤销！")&&l["delete"](e).success(function(t){if(console.log(t),0===t.error){var i=UIkit.modal("#bill-detail-modal");i.hide(),hMessage("账单删除成功！",2e3),$("#bill_"+e).remove()}else hMessage(t.msg,2e3)})},e.vModifyBill=function(){var e=UIkit.modal("#add-bill-modal");e.show(),t.templates.bill_add=t.templates.bill+"/bill_add_outcome.html",t.current_operation="modify_bill",t.bill_operation_trigger=0==t.bill_operation_trigger?1:0}}),note.controller("c_bill_query",function(e,t,i,o){e.bill_query_tip_show=!1,e.bill_query_tip="",e.bill_type=3,e.start_date=e.end_date=null,t.bills={},e.query=function(){e.bill_query_tip_show=!0,e.bill_query_tip="<i class='uk-icon-spinner'></i> 拼命查询中...";var i={start_date:e.start_date,end_date:e.end_date,bill_type:e.bill_type};console.log(i),o.query(i).success(function(i){console.log(i),0===i.error?(t.bills=i.bills,t.bills.length?e.bill_query_tip_show=!1:e.bill_query_tip="<i class='uk-icon-warning'></i> 查询不到符合条件的记录！"):e.bill_query_tip="<i class='uk-icon-warning'></i> "+i.msg})},e.billView=function(e){t.current_bill=t.bills[e];var i=UIkit.modal("#bill-detail-modal");i.show()}}),note.controller("c_bill_category",function(e,t,i,o){e.bill_category_type=1,e.bill_category_title="支出分类",e.bill_category_items={},e.is_self_defined=!1,e.toggle_type="off",e.added_bill_category="",e.added_child_bill_category="",e.current_bill_category={},e.current_child_bill_category={},e.modified_bill_category=e.modified_child_bill_category_name=e.modified_child_bill_category_balance=e.modified_child_bill_category_remarks="",o.getCategoryInfo(1).success(function(t){console.log(t),0===t.error&&(e.bill_category_items=t.bill_category_items,e.added_bill_category=e.bill_category_items[0].bill_category_id)}),e.switchCategoryType=function(){e.bill_category_type=1==e.bill_category_type?2:1,e.bill_category_title="支出分类"==e.bill_category_title?"收入分类":"支出分类",o.getCategoryInfo(e.bill_category_type).success(function(t){console.log(t),0===t.error&&(e.bill_category_items=t.bill_category_items,e.added_bill_category=e.bill_category_items[0].bill_category_id)})},e.updateCategory=function(){o.getCategoryInfo(e.bill_category_type).success(function(t){console.log(t),0===t.error&&(e.bill_category_items=t.bill_category_items,e.added_bill_category=e.bill_category_items[0].bill_category_id)})},e.vAddCategory=function(){UIkit.modal("#bill_category_add_modal").show()},e.addCategory=function(){var t=e.is_self_defined?1:0,i={is_self_defined:t,bill_type:e.bill_category_type,bill_category:e.added_bill_category,child_bill_category:e.added_child_bill_category};console.log(i),o.addCategory(i).success(function(t){0===t.error?(e.updateCategory(),hMessage("添加分类成功！")):hMessage(t.msg)})},e.switchAddSelfCategory=function(){e.is_self_defined?(e.toggle_type="off",e.added_bill_category=e.bill_category_items[0].bill_category.bill_category_id):(e.toggle_type="on",e.added_bill_category=""),e.is_self_defined=e.is_self_defined?!1:!0},e.vModifyBillCategory=function(t){e.current_bill_category=e.bill_category_items[t].bill_category,UIkit.modal("#bill_category_modify_modal").show()},e.modifyBillCategory=function(){console.log("修改一级分类："),console.log(e.current_bill_category),o.modifyCategory(e.current_bill_category.bill_category_id,e.current_bill_category.bill_category_name).success(function(t){console.log(t),0===t.error?(e.updateCategory(),hMessage("修改成功！")):hMessage(t.msg)})},e.deleteBillCategory=function(t){confirm("你确定要删除该一级分类-"+t+"(该分类下的所有二级分类和所有账单也将被删除！！)??")&&o.deleteCategory(t).success(function(t){0===t.error?(e.updateCategory(),hMessage("删除分类成功！")):hMessage(t.msg)})},e.vModifyChildBillCategory=function(t){for(var i=document.querySelector("#bill_category_item_"+t+" select"),o=i.options[i.selectedIndex].value.split(":")[1],l=0;l<e.bill_category_items[t].child_bill_categories.length;l++)e.bill_category_items[t].child_bill_categories[l].child_bill_category_id==o&&(e.current_child_bill_category=e.bill_category_items[t].child_bill_categories[l]);UIkit.modal("#child_bill_category_modify_modal").show()},e.modifyChildBillCategory=function(){console.log("修改二级分类："),console.log(e.current_child_bill_category),o.modifyChildCategory(e.current_child_bill_category.child_bill_category_id,e.current_child_bill_category.child_bill_category_name).success(function(t){console.log(t),0===t.error?(e.updateCategory(),hMessage("修改成功！")):hMessage(t.msg)})},e.deleteChildBillCategory=function(t){if(confirm("你确定要删除该二级分类(属于该分类的账单也会被一并删除！)??")){var i=document.querySelector("#bill_category_item_"+t+" select"),l=i.options[i.selectedIndex].value.split(":")[1];o.deleteChildCategory(l).success(function(t){0===t.error?(e.updateCategory(),hMessage("删除分类成功！")):hMessage(t.msg)})}}}),note.controller("c_accounts",function(e,t,i,o){e.current_account={},o.getAccounts().success(function(e){t.account_items=e.account_items,t.child_accounts=t.account_items[0].child_accounts}),setTitle("随手记-账户"),i.go("account_manage"),e.current_accounts_tab="",e.switchAccountsTab=function(t){e.current_accounts_tab=t,i.go(t,{reload:!0})}}),note.controller("c_account_view",function(e,t,i,o){e.current_account={},e.account_bills_tip_show=!1,o.getAccount(t.current_account_id).success(function(t){if(console.log(t),0===t.error){e.current_account.account=t.account,e.current_account.flow_in=0,e.current_account.flow_out=0,e.current_account.balance=parseFloat(e.current_account.account.child_account_balance);for(var i=0;i<e.current_account.account.bills.length;i++)1==e.current_account.account.bills[i].bill_type?e.current_account.flow_out+=parseFloat(e.current_account.account.bills[i].bill_sum):e.current_account.flow_in+=parseFloat(e.current_account.account.bills[i].bill_sum);e.account_bills_tip_show=i?!1:!0,e.current_account.balance+=e.current_account.flow_in-e.current_account.flow_out,console.log(e.current_account)}else hMessage(t.msg)}),e.showBillDetail=function(e){},e.backward=function(){i.go("account_manage")}}),note.controller("c_account_manage",function(e,t,i,o){e.account_items={},e.is_self_defined=!1,e.toggle_type="off",e.added_account="",e.modified_child_account={},e.modified_account={},e.added_child_account={},e.sum={},e.updateAccountList=function(){o.getAccountList().success(function(t){console.log(t),0===t.error?(e.account_items=t.account_list,e.added_account=e.account_items[0].account_id,e.sumAccounts(e.account_items)):hMessage(t.msg)})},e.updateAccountList(),e.sumAccounts=function(t){e.sum.balance=e.sum.flow_in=e.sum.flow_out=0;for(var i=0;i<t.length;i++)for(var o=0;o<t[i].child_accounts.length;o++)e.sum.flow_in+=parseFloat(t[i].child_accounts[o].flow_in),e.sum.flow_out+=parseFloat(t[i].child_accounts[o].flow_out),e.sum.balance+=parseFloat(t[i].child_accounts[o].child_account_balance);e.sum.balance+=e.sum.flow_in-e.sum.flow_out},e.vAddAccount=function(){UIkit.modal("#account_add_modal").show()},e.switchAddSelfAccount=function(){e.is_self_defined=e.is_self_defined?!1:!0,e.toggle_type="on"==e.toggle_type?"off":"on",e.added_account=""==e.added_account?e.account_items[0].account_id:""},e.addAccount=function(){var t=e.is_self_defined?1:0,i={is_self_defined:t,account:e.added_account,child_account_name:e.added_child_account.name,child_account_balance:e.added_child_account.default_balance,child_account_remarks:e.added_child_account.remarks};console.log(i),o.add(i).success(function(t){0===t.error?(e.updateAccountList(),hMessage("账户添加成功！")):hMessage(t.msg)})},e.vModifyAccount=function(t){e.modified_account=t,console.log(e.modified_account),UIkit.modal("#account_modify_modal").show()},e.vModifyChildAccount=function(t){e.modified_child_account=t,e.modified_child_account.balance=parseFloat(e.modified_child_account.child_account_balance)+e.modified_child_account.flow_in-e.modified_child_account.flow_out,console.log(e.modified_child_account),UIkit.modal("#child_account_modify_modal").show()},e.modifyAccount=function(){o.modifyAccount(e.modified_account).success(function(t){0===t.error?(e.updateAccountList(),hMessage("账户修改成功！")):hMessage(t.msg)})},e.modifyChildAccount=function(){var t=e.modified_child_account.balance-(parseFloat(e.modified_child_account.child_account_balance)+(e.modified_child_account.flow_in-e.modified_child_account.flow_out));e.modified_child_account.child_account_balance=parseFloat(e.modified_child_account.child_account_balance)+t,o.modifyChildAccount(e.modified_child_account).success(function(t){0===t.error?(e.updateAccountList(),hMessage("账户修改成功！")):hMessage(t.msg)})},e.deleteAccount=function(t){confirm("你确定要删除该一级账户??该账户下所有的子账户及其账单都将被删除！！")&&(console.log("删除一级账户:"+t),o["delete"](t,1).success(function(t){0===t.error?(e.updateAccountList(),hMessage("账户删除成功！")):hMessage(t.msg)}))},e.deleteChildAccount=function(t){confirm("你确定要删除该二级账户??该账户下所有的账单都将被删除！！")&&(console.log("删除二级账户:"+t),o["delete"](t,2).success(function(t){0===t.error?(e.updateAccountList(),hMessage("账户删除成功！")):hMessage(t.msg)}))},e.viewChildAccount=function(e){t.current_account_id=e,console.log("account_id:"+e),i.go("account")}}),note.controller("c_charts",function(e,t,i,o,l){l.go("compare"),e.current_charts_tab="compare",e.switchChartsTab=function(t){e.current_charts_tab=t,l.go(t)},t.clone=function(t){if(null==t||"object"!=typeof t)return t;if(t instanceof Date){var i=new Date;return i.setTime(t.getTime()),i}if(t instanceof Array){for(var i=[],o=0;o<t.length;++o)i[o]=e.clone(t[o]);return i}if(t instanceof Object){var i={};for(var l in t)t.hasOwnProperty(l)&&(i[l]=e.clone(t[l]));return i}throw new Error("Unable to copy obj! Its type isn't supported.")},t.pie_options={},t.pie_options.title={text:"",subtext:"",x:"center"},t.pie_options.legend={orient:"vertical",x:"left",data:[]},t.pie_options.calculable=!0,t.pie_options.tooltip={trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},t.pie_options.series=[{name:"",type:"pie",radius:"55%",center:["50%","60%"],data:[]}],t.line_options={},t.line_options.title={text:"",subtext:""},t.line_options.tooltip={trigger:"axis"},t.line_options.legend={data:[]},t.line_options.calculable=!0,t.line_options.xAxis=[{type:"category",boundaryGap:!1,data:[]}],t.line_options.yAxis=[{type:"value",axisLabel:{formatter:"{value}"}}],t.line_options.series=[]}),note.controller("c_charts_distribute",function(e,t,i,o,l){e.distribute_option="0",e.start_date=e.end_date="",e.charts_distribute_tip='<i class="uk-icon-warning"></i> 请输入查询条件查询！',e.initCharts=function(){},e.income_distribute_chart=echarts.init(document.getElementById("charts-distribute-pie-income")),e.outcome_distribute_chart=echarts.init(document.getElementById("charts-distribute-pie-outcome")),e.query=function(){e.income_distribute_chart.clear(),e.outcome_distribute_chart.clear(),e.income_distribute_chart_options=t.clone(t.pie_options),e.income_distribute_chart_options.title.text="收入分布图",e.income_distribute_chart_options.title.subtext="0"==e.distribute_option?"账户":"分类",e.income_distribute_chart_options.series[0].name="账户",e.outcome_distribute_chart_options=t.clone(t.pie_options),e.outcome_distribute_chart_options.title.text="支出分布图",e.outcome_distribute_chart_options.title.subtext="0"==e.distribute_option?"账户":"分类",e.outcome_distribute_chart_options.series[0].name="账户",e.outcome_distribute_chart_options.legend.data=[],e.outcome_distribute_chart_options.series[0].data=[],e.income_distribute_chart_options.legend.data=[],e.income_distribute_chart_options.series[0].data=[];var i={start_date:e.start_date,end_date:e.end_date,distribute:e.distribute_option};o.getDistributeData(i).success(function(t){if(console.log(i),0===t.error){if("0"==e.distribute_option)for(var o=0;o<t.bills.length;o++)1==t.bills[o].bill_type?(e.outcome_distribute_chart_options.legend.data.push(t.bills[o].child_account_name),e.outcome_distribute_chart_options.series[0].data.push({value:t.bills[o].bills_sum,name:t.bills[o].child_account_name})):(e.income_distribute_chart_options.legend.data.push(t.bills[o].child_account_name),e.income_distribute_chart_options.series[0].data.push({value:t.bills[o].bills_sum,name:t.bills[o].child_account_name}));else for(var o=0;o<t.bills.length;o++)1==t.bills[o].bill_type?(e.outcome_distribute_chart_options.legend.data.push(t.bills[o].child_bill_category_name),e.outcome_distribute_chart_options.series[0].data.push({value:t.bills[o].bills_sum,name:t.bills[o].child_bill_category_name})):(e.income_distribute_chart_options.legend.data.push(t.bills[o].child_bill_category_name),e.income_distribute_chart_options.series[0].data.push({value:t.bills[o].bills_sum,name:t.bills[o].child_bill_category_name}));o?(e.income_distribute_chart.dispose(),e.outcome_distribute_chart.dispose(),e.income_distribute_chart=echarts.init(document.getElementById("charts-distribute-pie-income")),e.outcome_distribute_chart=echarts.init(document.getElementById("charts-distribute-pie-outcome")),e.charts_distribute_tip=""):e.charts_distribute_tip='<i class="uk-icon-warning"></i> 未查到相关信息！',e.income_distribute_chart.setOption(e.income_distribute_chart_options),e.outcome_distribute_chart.setOption(e.outcome_distribute_chart_options)}else hMessage(t.msg)})}}),note.controller("c_charts_compare",function(e,t,i,o,l){e.start_date=e.end_date="",e.charts_compare_tip='<i class="uk-icon-warning"></i> 请输入查询条件查询！',e.compare_chart=echarts.init(document.getElementById("charts-compare-pie")),e.query=function(){e.compare_chart.clear(),e.compare_chart_options=t.clone(t.pie_options),e.compare_chart_options.title.text="收支对比图",e.compare_chart_options.series[0].name="金额",e.compare_chart_options.legend.data=[],e.compare_chart_options.series[0].data=[];var i={start_date:e.start_date,end_date:e.end_date};o.getCompareData(i).success(function(t){if(console.log(t),0===t.error){for(var i=0;i<t.bills.length;i++)1==t.bills[i].bill_type?(e.compare_chart_options.legend.data.push("支出"),e.compare_chart_options.series[0].data.push({value:t.bills[i].bills_sum,name:"支出"})):(e.compare_chart_options.legend.data.push("收入"),e.compare_chart_options.series[0].data.push({value:t.bills[i].bills_sum,name:"收入"}));i?(e.compare_chart.dispose(),e.compare_chart=echarts.init(document.getElementById("charts-compare-pie")),e.charts_compare_tip=""):e.charts_compare_tip='<i class="uk-icon-warning"></i> 未查到相关信息！',e.compare_chart.setOption(e.compare_chart_options)}else hMessage(t.msg)})}}),note.controller("c_charts_trend",function(e,t,i,o,l){e.time_gap="0",e.start_date=e.end_date="",e.charts_trend_tip='<i class="uk-icon-warning"></i> 请输入查询条件查询！',e.outcome_trend_chart=echarts.init(document.getElementById("charts-trend-line-outcome")),e.income_trend_chart=echarts.init(document.getElementById("charts-trend-line-income")),e.query=function(){e.outcome_trend_chart.clear(),e.income_trend_chart.clear(),e.outcome_trend_chart_options=t.clone(t.line_options),e.income_trend_chart_options=t.clone(t.line_options),e.outcome_trend_chart_options.title.text="支出趋势图",e.income_trend_chart_options.title.text="收入趋势图",e.outcome_trend_chart_options.legend.data=["支出"],e.outcome_trend_chart_options.xAxis[0].data=[],e.outcome_trend_chart_options.series[0]={},e.outcome_trend_chart_options.series[0].name="支出",e.outcome_trend_chart_options.series[0].type="line",e.outcome_trend_chart_options.series[0].data=[],e.income_trend_chart_options.legend.data=["收入"],e.income_trend_chart_options.xAxis[0].data=[],e.income_trend_chart_options.series[0]={},e.income_trend_chart_options.series[0].name="支出",e.income_trend_chart_options.series[0].type="line",e.income_trend_chart_options.series[0].data=[];var i={start_date:e.start_date,end_date:e.end_date};o.getTrendData(i).success(function(t){if(console.log(t),0===t.error){for(var i=0;i<t.outcome_bills.length;i++)e.outcome_trend_chart_options.xAxis[0].data.push(t.outcome_bills[i].bill_time),e.outcome_trend_chart_options.series[0].data.push(t.outcome_bills[i].bill_sum);for(var o=0;o<t.income_bills.length;o++)e.income_trend_chart_options.xAxis[0].data.push(t.income_bills[o].bill_time),
e.income_trend_chart_options.series[0].data.push(t.income_bills[o].bill_sum);e.charts_trend_tip=i||o?"":'<i class="uk-icon-warning"></i> 未查到相关信息！',e.outcome_trend_chart.setOption(e.outcome_trend_chart_options),e.income_trend_chart.setOption(e.income_trend_chart_options)}else hMessage(t.msg)})}}),note.controller("c_property_trend",function(e,t,i,o,l){e.start_date=e.end_date="",e.charts_property_trend_tip='<i class="uk-icon-warning"></i> 请输入查询条件查询！',e.property_trend_chart=echarts.init(document.getElementById("charts-property-trend-line")),e.query=function(){e.property_trend_chart.clear(),e.property_trend_chart_options=t.clone(t.line_options),e.property_trend_chart_options.title.text="资产趋势图",e.property_trend_chart_options.legend.data=["资产"],e.property_trend_chart_options.xAxis[0].data=[],e.property_trend_chart_options.series[0]={},e.property_trend_chart_options.series[0].name="资产",e.property_trend_chart_options.series[0].type="line",e.property_trend_chart_options.series[0].data=[];var i={start_date:e.start_date,end_date:e.end_date};o.getPropertyTrendData(i).success(function(t){if(console.log(t),0===t.error){for(var i=0;i<t.outcome_bills.length;i++)e.property_trend_chart_options.xAxis[0].data.push(t.outcome_bills[i].bill_time),e.property_trend_chart_options.series[0].data.push(t.outcome_bills[i].bill_sum);e.charts_property_trend_tip=i?"":'<i class="uk-icon-warning"></i> 未查到相关信息！',e.property_trend_chart.setOption(e.property_trend_chart_options)}else hMessage(t.msg)})}}),note.controller("c_user",function(e,t,i){t.go("basicInfo"),i.current_user_tab="basicInfo",e.switchUserTab=function(e){i.current_user_tab=e,t.go(e)}}),note.controller("c_user_basicInfo",function(e,t,i,o,l){i.current_user_tab="basicInfo",l.getBasicInfo().success(function(e){if(0===e.error){i.user={},i.user.name=e.user.user_name,i.username_text='<i class="uk-icon-user"></i> '+e.user.user_name,i.user.email=e.user.user_email;var t=/^(https|http|www)/g;i.user.avatar=t.test(e.user.user_avatar)?e.user.user_avatar:public_path+"/img/avatar/"+e.user.user_avatar}}),e.logout=function(){l.logout().success(function(e){0===e.error?(hMessage("退出登陆成功！",1200),o("is_logined",0),i.login_register_show=!0,i.user_show=!1,i.username_text="",setTimeout(function(){t.go("login")},1200)):hMessage(e.msg)})},e.modifyUserInfo=function(){var e=UIkit.modal("#modify-userInfo-modal");e.isActive()?e.hide():e.show()}}),note.controller("c_user_modifyPasswd",function(e,t,i,o,l){i.current_user_tab="modifyPasswd",e.old_password=e.new_password=e.password_confirm="",e.resetPassword=function(){if(checkEmpty(e.old_password)||checkEmpty(e.new_password)||checkEmpty(e.password_confirm))return void hMessage("密码不能为空(不能包含空格等非显示字符)！");if(e.new_password.length<6&&e.new_password.length>0)return void hMessage("请输入六位以上的密码！");if(e.new_password!==e.password_confirm)return void hMessage("新密码与确认密码不相等！");var i={old_password:e.old_password,new_password:e.new_password,password_confirm:e.password_confirm};l.modifyPassword(i).success(function(e){0===e.error?(hMessage("密码修改成功，请使用新的密码登陆！",2e3),o(function(){t.go("login")},2e3)):hMessage(e.msg,2e3)})}}),note.controller("c_modify_userInfo_modal",function(e,t,i,o,l,c){e.avatar_upload_url="http://localhost/M-Note/index.php/Home/User/upload_user_avatar.html",e.user_name=e.user_email="",e.uploadAvatarBtn="上传头像",e.uploadUserAvatar=function(){var t=!0,l=200,c=document.getElementById("user_avatar_img").files[0];if(null==c)hMessage("请先选择图片！"),t=!1;else{"image/jpeg"!=c.type&&"image/jpg"!=c.type&&"image/png"!=c.type&&t&&(hMessage("请选择正确的图片格式：jpeg,jpg,png！"),t=!1);var a=c.size/1048576;a>2&&t&&(hMessage("上传图片请限制在2M以内！"),t=!1)}if(t){$("form.upload-avatar-form").submit(),e.uploadAvatarBtn="上传中...";var n=o(function(){if(void 0!=$(window.frames.upload_avatar_iframe.document).find("pre").html()){var t=JSON.parse($(window.frames.upload_avatar_iframe.document).find("pre").html());if(console.log(t),0==t.error){var l=/^(https|http|www)/g;i.user.avatar=l.test(t.url)?t.url:public_path+"/img/avatar/"+t.url,e.uploadAvatarBtn="上传成功！",hMessage("上传成功！"),o(function(){e.uploadAvatarBtn="上传头像"},2e3)}else hMessage(t.msg);$(window.frames.upload_avatar_iframe.document).find("pre").html(""),o.cancel(n)}},l)}},e.modifyUserInfo=function(){if(e.user_name.length<1&&e.user_email.length<1)return void hMessage("不能提交空信息，请至少修改一项！");if(e.user_name.length>0&&!usernameVerify(e.user_name))return void hMessage("用户名只能以英文字母或中文开头,包含数字，下划线，字母，中文！",3e3);if(e.user_email.length>0&&!emailVerify(e.user_email))return void hMessage("请输入正确的邮箱格式！");console.log("username:"+e.user_name+",email:"+e.user_email);var t={username:e.user_name,user_email:e.user_email};c.modifyUserInfo(t).success(function(t){console.log(t),0===t.error?(i.user.name=t.user.user_name,i.username_text='<i class="uk-icon-user"></i> '+t.user.user_name,i.user.email=t.user.user_email,l("username",e.user_name),hMessage("用户信息修改成功！",2e3),setTimeout(function(){var e=UIkit.modal("#modify-userInfo-modal");e.hide()},1e3)):hMessage(t.msg,2e3)})}});