var note=angular.module("M_NOTE",["ui.router","ipCookie"]);note.filter("trustHtml",function($sce){return function(input){return $sce.trustAsHtml(input)}}),note.filter("subStr",function(){return function(input,limit){return input.replace(/<[^>]+>/g,"").substr(0,limit)}}),note.filter("subFloat",function(){return function(input,bit){return Math.round(input*Math.pow(10,bit))/Math.pow(10,bit)}}),note.config(["$locationProvider","$urlRouterProvider","$compileProvider",function($locationProvider,$urlRouterProvider,$compileProvider){$urlRouterProvider.otherwise(""),$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|javascript):/)}]),note.config(["$httpProvider",function($httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",$httpProvider.defaults.headers.common["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var param=function(obj){var name,value,fullSubName,subName,subValue,innerObj,i,query="";for(name in obj)if(value=obj[name],value instanceof Array)for(i=0;i<value.length;++i)subValue=value[i],fullSubName=name+"["+i+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else if(value instanceof Object)for(subName in value)subValue=value[subName],fullSubName=name+"["+subName+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else void 0!==value&&null!==value&&(query+=encodeURIComponent(name)+"="+encodeURIComponent(value)+"&");return query.length?query.substr(0,query.length-1):query};$httpProvider.defaults.transformRequest=[function(data){return angular.isObject(data)&&"[object File]"!==String(data)?param(data):data}]}]),note.config(["$stateProvider",function($stateProvider){$stateProvider.state("home",{url:"/home",views:{content:{templateUrl:templates_path+"/home.html"}}}).state("welcome",{url:"/welcome",views:{content:{templateUrl:templates_path+"/welcome.html"}}}).state("login",{url:"/login",views:{content:{templateUrl:templates_path+"/login.html"}}}).state("register",{url:"/register",views:{content:{templateUrl:templates_path+"/register.html"}}})}]),note.config(["$stateProvider",function($stateProvider){$stateProvider.state("bill",{url:"/bill",views:{content:{templateUrl:templates_path+"/bill/bill.html"}}}).state("today_bills",{url:"/today_bills",parent:"bill",views:{bill_view:{templateUrl:templates_path+"/bill/today_bills.html"}}}).state("bill_query",{url:"/query",parent:"bill",views:{bill_view:{templateUrl:templates_path+"/bill/bill_query.html"}}}).state("bill_category",{url:"/category",parent:"bill",views:{bill_view:{templateUrl:templates_path+"/bill/bill_category.html"}}}).state("bill_details",{url:"/bill/:billId",parent:"today_bills",views:{bill_details_view:{templateUrl:templates_path+"/bill/bill_details.html"}}}).state("modify_bill",{url:"/modify",parent:"today_bills",views:{bill_details_view:{templateUrl:templates_path+"/bill/modify_bill.html"}}}).state("modify_bill_outcome",{url:"/modify_bill_outcome",parent:"modify_bill",views:{modify_bill_view:{templateUrl:templates_path+"/bill/modify_bill_outcome.html"}}}).state("modify_bill_income",{url:"/modify_bill_income",parent:"modify_bill",views:{modify_bill_view:{templateUrl:templates_path+"/bill/modify_bill_income.html"}}}).state("bill_add_outcome",{url:"/add/outcome",parent:"bill",views:{bill_add_view:{templateUrl:templates_path+"/bill/bill_add_outcome.html"}}}).state("bill_add_income",{url:"/add/income",parent:"bill",views:{bill_add_view:{templateUrl:templates_path+"/bill/bill_add_income.html"}}}).state("add_category",{url:"/add/category",parent:"bill",views:{bill_add_view:{templateUrl:templates_path+"/bill/add_category.html"}}}).state("add_account",{url:"/add/account",parent:"bill",views:{bill_add_view:{templateUrl:templates_path+"/bill/add_account.html"}}})}]),note.config(["$stateProvider",function($stateProvider){$stateProvider.state("charts",{url:"/charts",views:{content:{templateUrl:templates_path+"/charts/charts.html"}}}).state("budget",{url:"/budget",parent:"charts",views:{charts_view:{templateUrl:templates_path+"/charts/budget.html"}}}).state("distribute",{url:"/distribute",parent:"charts",views:{charts_view:{templateUrl:templates_path+"/charts/distribute.html"}}}).state("compare",{url:"/compare",parent:"charts",views:{charts_view:{templateUrl:templates_path+"/charts/compare.html"}}}).state("trend",{url:"/trend",parent:"charts",views:{charts_view:{templateUrl:templates_path+"/charts/trend.html"}}}).state("property_distribute",{url:"/property/distribute",parent:"charts",views:{charts_view:{templateUrl:templates_path+"/charts/property_distribute.html"}}}).state("property_trend",{url:"/property/trend",parent:"charts",views:{charts_view:{templateUrl:templates_path+"/charts/property_trend.html"}}})}]),note.config(["$stateProvider",function($stateProvider){$stateProvider.state("accounts",{url:"/accounts",views:{content:{templateUrl:templates_path+"/accounts/accounts.html"}}}).state("accounts_sum",{url:"/accounts_sum",parent:"accounts",views:{accounts_view:{templateUrl:templates_path+"/accounts/accounts_sum.html"}}}).state("account",{url:"/account",parent:"accounts",views:{accounts_view:{templateUrl:templates_path+"/accounts/account.html"}}}).state("account_manage",{url:"/manage",parent:"accounts",views:{accounts_view:{templateUrl:templates_path+"/accounts/manage.html"}}}).state("account_transfer",{url:"/transfer",parent:"accounts",views:{accounts_view:{templateUrl:templates_path+"/accounts/transfer.html"}}}).state("account_transfer_query",{url:"/transfer/query",parent:"accounts",views:{accounts_view:{templateUrl:templates_path+"/accounts/transfer_query.html"}}})}]),note.config(["$stateProvider",function($stateProvider){$stateProvider.state("user",{url:"/user",views:{content:{templateUrl:templates_path+"/user/user.html"}}}).state("basicInfo",{url:"/basicInfo",parent:"user",views:{user_view:{templateUrl:templates_path+"/user/basicInfo.html"}}}).state("modifyPasswd",{url:"/modifyPasswd",parent:"user",views:{user_view:{templateUrl:templates_path+"/user/modifyPasswd.html"}}})}]),note.service("validator",function(){this.checkEmail=function(email){var re=/^[\u4e00-\u9fa5a-zA-Z\d]+([-_.][\u4e00-\u9fa5A-Za-z\d]+)*@([\u4e00-\u9fa5A-Za-z\d]+[-.]){1,2}[\u4e00-\u9fa5A-Za-z\d]{2,5}$/g;return re.test(email)},this.checkUsername=function(username){var re=/^([a-z,A-Z,\u4e00-\u9fa5])([\w,\d,\u4e00-\u9fa5,_])*$/g;return re.test(username)},this.isEmpty=function(value){var re=/^[\s,\n,\t]*$/g;return re.test(value)}}),note.service("User",function($http){this.register=function(registerInfo){return $http({method:"POST",url:home_path+"/User/register.html",data:registerInfo})},this.login=function(loginInfo){return $http({method:"POST",url:home_path+"/User/login.html",data:loginInfo})},this.logout=function(){return $http({method:"GET",url:home_path+"/User/logout.html"})},this.getBasicInfo=function(){return $http({method:"GET",url:home_path+"/User/get_user_basic_info.html"})},this.modifyUserInfo=function(userInfo){return $http({method:"POST",url:home_path+"/User/modify_user_basic_info.html",data:userInfo})},this.modifyPassword=function(passwordInfo){return $http({method:"POST",url:home_path+"/User/modify_user_password.html",data:passwordInfo})},this.uploadAvatar=function(registerInfo){}}),note.service("Bill",function($http){this.add=function(bill){return $http({method:"POST",url:home_path+"/Bill/add_bill.html",data:bill})},this["delete"]=function(bill_id){return $http({method:"POST",url:home_path+"/Bill/delete_bill.html",data:{bill_id:bill_id}})},this.query=function(condition){return $http({method:"POST",url:home_path+"/Bill/bill_query.html",data:condition})},this.modify=function(bill){return $http({method:"POST",url:home_path+"/Bill/modify_bill.html",data:bill})},this.getTodayBills=function(){return $http({method:"GET",url:home_path+"/Bill/get_today_bills.html"})},this.getBillById=function(bill_id){return $http({method:"GET",url:home_path+"/Bill/get_bill_by_id.html?bill_id="+bill_id})},this.view=function(billId){},this.getCategoryInfo=function(type){return $http({method:"GET",url:home_path+"/Bill/get_user_bill_categories.html?type="+type})},this.addCategory=function(categoryItem){return $http({method:"POST",url:home_path+"/Bill/add_bill_category.html",data:categoryItem})},this.deleteCategory=function(bill_category_id){return $http({method:"POST",url:home_path+"/Bill/delete_bill_category.html",data:{bill_category_id:bill_category_id}})},this.deleteChildCategory=function(child_bill_category_id){return $http({method:"POST",url:home_path+"/Bill/delete_child_bill_category.html",data:{child_bill_category_id:child_bill_category_id}})},this.modifyCategory=function(bill_category_id,bill_category_name){return $http({method:"POST",url:home_path+"/Bill/modify_bill_category.html",data:{bill_category_id:bill_category_id,bill_category_name:bill_category_name}})},this.modifyChildCategory=function(child_bill_category_id,child_bill_category_name){return $http({method:"POST",url:home_path+"/Bill/modify_child_bill_category.html",data:{child_bill_category_id:child_bill_category_id,child_bill_category_name:child_bill_category_name}})}}),note.service("Account",function($http){this.add=function(account){return $http({method:"POST",url:home_path+"/Account/add_account.html",data:account})},this["delete"]=function(account_id,type){return $http({method:"POST",url:home_path+"/Account/delete_account.html",data:{account_id:account_id,type:type}})},this.query=function(condition){return $http({method:"POST",url:home_path+"/Account/account_query.html",data:condition})},this.modifyAccount=function(modified_account){return $http({method:"POST",url:home_path+"/Account/modify_account.html",data:{account_name:modified_account.account_name,account_id:modified_account.account_id}})},this.modifyChildAccount=function(modified_child_account){return $http({method:"POST",url:home_path+"/Account/modify_child_account.html",data:{child_account_id:modified_child_account.child_account_id,child_account_name:modified_child_account.child_account_name,child_account_balance:modified_child_account.child_account_balance,child_account_remarks:modified_child_account.child_account_remarks}})},this.getBasicAccountItems=function(){return $http({method:"GET",url:home_path+"/Account/get_basic_account_items.html"})},this.getDetailedAccountItems=function(condition){return $http({method:"POST",url:home_path+"/Account/get_detailed_account_items.html",data:condition})},this.getAccount=function(account_id){return $http({method:"POST",url:home_path+"/Account/get_account.html",data:{account_id:account_id}})},this.transfer=function(condition){return $http({method:"POST",url:home_path+"/Account/transfer.html",data:condition})}}),note.service("Charts",function($http){this.getDistributeData=function(cdt){return $http({method:"POST",url:home_path+"/Charts/get_distribute_data.html",data:{cdt:cdt}})},this.getCompareData=function(cdt){return $http({method:"POST",url:home_path+"/Charts/get_compare_data.html",data:{cdt:cdt}})},this.getTrendData=function(cdt){return $http({method:"POST",url:home_path+"/Charts/get_trend_data.html",data:{cdt:cdt}})},this.getPropertyDistributeData=function(cdt){return $http({method:"POST",url:home_path+"/Charts/get_property_distribute_data.html",data:cdt})},this.getPropertyTrendData=function(cdt){return $http({method:"GET",url:home_path+"/Charts/get_property_trend_data.html?end_date="+cdt.end_date})},this.getBudgetData=function(){return $http({method:"GET",url:home_path+"/Charts/get_budget_data.html"})},this.modifyBudget=function(cdt){return $http({method:"POST",url:home_path+"/Charts/modify_budget.html",data:cdt})}});var site_prefix="http://localhost/note2/";note.controller("c_index",function($scope,$rootScope,$state,$http,$location,$log,ipCookie){$state.go("home"),$rootScope.$on("$locationChangeStart",function(event){if(!ipCookie("is_logined")){console.log(arguments);var url_suffix=arguments[1].split("#")[1];url_suffix=void 0==url_suffix?"/#":url_suffix,console.log(url_suffix),"/login"!=url_suffix&&"/register"!=url_suffix&&"/welcome"!=url_suffix&&$state.go("welcome")}}),$rootScope.clone=function(obj){if(null==obj||"object"!=typeof obj)return obj;if(obj instanceof Date){var copy=new Date;return copy.setTime(obj.getTime()),copy}if(obj instanceof Array){for(var copy=[],i=0;i<obj.length;++i)copy[i]=$scope.clone(obj[i]);return copy}if(obj instanceof Object){var copy={};for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=$scope.clone(obj[attr]));return copy}throw new Error("Unable to copy obj! Its type isn't supported.")},$rootScope.pie_options={},$rootScope.pie_options.title={text:"",subtext:"",x:"center"},$rootScope.pie_options.legend={orient:"vertical",x:"left",data:[]},$rootScope.pie_options.calculable=!0,$rootScope.pie_options.tooltip={trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},$rootScope.pie_options.series=[{name:"",type:"pie",radius:"55%",center:["50%","60%"],data:[]}],$rootScope.line_options={},$rootScope.line_options.title={text:"",subtext:""},$rootScope.line_options.tooltip={trigger:"axis"},$rootScope.line_options.legend={data:[]},$rootScope.line_options.calculable=!0,$rootScope.line_options.xAxis=[{type:"category",boundaryGap:!1,data:[]}],$rootScope.line_options.yAxis=[{type:"value",axisLabel:{formatter:"{value}"}}],$rootScope.line_options.series=[];var date=new Date,last_day=new Date(date.getFullYear(),date.getMonth()+1,0).getDate();$rootScope.sdate=date.getFullYear()+"-"+(date.getMonth()+1)+"-1",$rootScope.edate=date.getFullYear()+"-"+(date.getMonth()+1)+"-"+last_day}),note.controller("c_nav",function($scope,$state,$rootScope,$http,ipCookie){$scope.current_tab="home",$scope.switchTab=function(tab){return $scope.current_tab=tab,ipCookie("is_logined")||"welcome"===tab?ipCookie("is_logined")||"welcome"!==tab?ipCookie("is_logined")&&"welcome"===tab?(console.log("home"),void $state.go("home")):void $state.go(tab):(console.log("welcome"),void $state.go("welcome")):void console.log("nothing")},ipCookie("is_logined")?($rootScope.login_register_show=!1,$rootScope.user_show=!0,$rootScope.username_text='<i class="uk-icon-user"></i> '+ipCookie("username")):($rootScope.login_register_show=!0,$rootScope.user_show=!1,$rootScope.username_text="")}),note.controller("c_login",function($scope,$state,$rootScope,$timeout,ipCookie,User){setTitle("随手记-登陆"),$scope.username=$scope.password="";var loginable=!0;$scope.login=function(){if(!loginable)return void hMessage("正在登陆，请耐心等待...");if(loginable=!1,$scope.username.length<1||$scope.password.length<1)return void hMessage("用户名或密码不能为空！",2e3);if($scope.password.length>=1&&$scope.password.length<6)return void hMessage("请输入6位以上的密码！",2e3);var loginInfo={username:$scope.username,password:$scope.password},is_new=!0;$timeout(function(){is_new&&hMessage("这可能是你的第一次登陆，相关数据正在初始化，请耐心等候...")},3e3),User.login(loginInfo).success(function(res){is_new=!1,0===res.error?(loginable=!0,hMessage("登陆成功！",1500),$rootScope.login_register_show=!1,$rootScope.user_show=!0,$rootScope.user={},$rootScope.user.is_logined=!0,console.log("已登陆"),ipCookie("is_logined",1),ipCookie("username",$scope.username),$rootScope.user.name=$scope.username,$rootScope.username_text='<i class="uk-icon-user"></i> '+$scope.username,$rootScope.user.email="819537918@qq.com",$rootScope.user.id=1e3,$rootScope.user.avatar="https://dn-lanbaidiao.qbox.me/avatar_1000_a645761e1fc399f5be08308eacead7ce?imageView2/1/w/80/h/80",setTimeout(function(){$state.go("home")},1500)):2===res.error?(hMessage("该用户不存在！",1500),loginable=!0):(hMessage(res.msg,2e3),loginable=!0)}).error(function(data,state){console.log(data),console.log(state)})}}),note.controller("c_register",function($scope,$state,User){setTitle("随手记-注册"),$scope.username=$scope.email=$scope.password=$scope.password_confirm="";var registerable=!0;$scope.register=function(){if(!registerable)return void hMessage("正在登陆，请耐心等待...");if(registerable=!1,console.log($scope.username+","+$scope.email+","+$scope.password+","+$scope.password_confirm),$scope.username.length<1)return void hMessage("用户名不能为空！",2e3);if(!usernameVerify($scope.username))return void hMessage("用户名只能以英文字母或中文开头,包含数字，下划线，字母，中文！",3e3);if($scope.email.length<1)return void hMessage("邮箱不能为空！",2e3);if(!emailVerify($scope.email))return void hMessage("请输入正确的邮箱格式！",2e3);if(checkEmpty($scope.password))return void hMessage("密码不能为空！",2e3);if($scope.password.length>1&&$scope.password.length<6)return void hMessage("请输入6位以上的密码！",2e3);if($scope.password!==$scope.password_confirm)return void hMessage("两次输入的密码不一致！",2e3);document.getElementById("register-btn").innerHTML="注册中...",document.getElementById("register-btn").disabled="disabled";var registerInfo={username:$scope.username,email:$scope.email,password:$scope.password,password_confirm:$scope.password_confirm};User.register(registerInfo).success(function(res){0===res.error?(registerable=!0,hMessage("注册成功，请登陆！",2e3),$state.go("login")):(hMessage(res.msg,2e3),registerable=!0),document.getElementById("register-btn").innerHTML="注册",document.getElementById("register-btn").disabled=!1})}}),note.controller("c_bill",function($scope,$rootScope,$state){setTitle("随手记-记账"),$rootScope.bill_operation_trigger=0,$rootScope.current_operation="add_bill",$rootScope.account_items=$rootScope.child_accounts=$rootScope.bill_category_items=$rootScope.child_bill_categories={},$state.go("today_bills"),$rootScope.templates={},$rootScope.templates.bill=templates_path+"/bill",$rootScope.templates.bill_add=$rootScope.templates.bill+"/bill_add_outcome.html",$rootScope.templates.bill_view=$rootScope.templates.bill+"/bill_details.html",$rootScope.templates.add_category=$rootScope.templates.bill+"/add_category.html",$rootScope.templates.add_account=$rootScope.templates.bill+"/add_account.html",$scope.current_bill_tab="today_bills",$scope.switchBillTab=function(tab){$scope.current_bill_tab=tab,$state.go(tab)}}),note.controller("c_today_bills",function($scope,$rootScope,$state,$http,Bill){$rootScope.bill_tip_show=!0,$rootScope.bill_tip="今天还没有账单信息，快去记一笔吧！",Bill.getTodayBills().success(function(res){0===res.error?($rootScope.bills=res.bills,$rootScope.bill_tip_show=!1):2===res.error?($rootScope.bills=[],$rootScope.bill_tip_show=!0):hMessage(res.msg)}).error(function(data,state){console.log(data)}),$scope.vAddBill=function(){$rootScope.templates.bill_add=$rootScope.templates.bill+"/bill_add_outcome.html",$rootScope.current_operation="add_bill",$rootScope.bill_operation_trigger=0==$rootScope.bill_operation_trigger?1:0;var add_bill_modal=UIkit.modal("#add-bill-modal");add_bill_modal.show()},$scope.showBillDetail=function(index){$rootScope.current_bill=$rootScope.bills[index];var bill_detail_modal=UIkit.modal("#bill-detail-modal");bill_detail_modal.show()}}),note.controller("c_bill_add",function($scope,$rootScope,$state,$http,$timeout,Bill,Account){$scope.bill_category={},$scope.current_bill_view=$rootScope.previous_view="outcome",$scope.bill={},$scope.bill.time={},$scope.$watch("bill.date",function(newValue,oldValue){$scope.hours=[],$scope.minutes=[];var today=(new Date).getDate(),bill_date=new Date(newValue).getDate();if(console.log("bill_date:"+bill_date),today==bill_date){for(var i=0;i<parseInt((new Date).getHours())+1;i++)$scope.hours.push(i);for(var i=0;i<parseInt((new Date).getMinutes())+1;i++)$scope.minutes.push(i)}else{for(var i=0;24>i;i++)$scope.hours.push(i);for(var i=0;60>i;i++)$scope.minutes.push(i)}$scope.bill.time.hour=parseInt((new Date).getHours()),$scope.bill.time.minute=parseInt((new Date).getMinutes())}),Account.getBasicAccountItems().success(function(res){console.log(res),$rootScope.account_items=res.account_items,$rootScope.child_accounts=$rootScope.account_items[0].child_accounts,$scope.bill.account=$rootScope.account_items[0].account_id,$scope.bill.child_account=$rootScope.account_items[0].child_accounts[0].child_account_id}),$rootScope.$watch("bill_operation_trigger",function(newValue,oldValue){if("modify_bill"==$rootScope.current_operation){console.log("触发器被触发了！"),console.log("newValue:"+newValue+",oldValue:"+oldValue),console.log("当前是修改操作"),$scope.bill_type=1==$rootScope.current_bill.bill_type?1:2,$scope.bill_type_text=1==$rootScope.current_bill.bill_type?"记账-支出":"记账-收入",console.log("bill_type:"+$scope.bill_type);var type=1==$scope.bill_type?"outcome":"income";"outcome"==type?Bill.getCategoryInfo(1).success(function(res){console.log(res),$rootScope.bill_category_items=res.bill_category_items;for(var i=0;i<$rootScope.bill_category_items.length&&$rootScope.bill_category_items[i].bill_category_id!=$rootScope.current_bill.bill_category_id;i++);$rootScope.child_bill_categories=$rootScope.bill_category_items[i].child_bill_categories}):Bill.getCategoryInfo(2).success(function(res){console.log(res),$rootScope.bill_category_items=res.bill_category_items;for(var i=0;i<$rootScope.bill_category_items.length&&$rootScope.bill_category_items[i].bill_category_id!=$rootScope.current_bill.bill_category_id;i++);$rootScope.child_bill_categories=$rootScope.bill_category_items[i].child_bill_categories}),$scope.bill.category=$rootScope.current_bill.bill_category_id,$scope.bill.child_category=$rootScope.current_bill.child_bill_category_id,console.log("category:"+$scope.bill.category+",child_category:"+$scope.bill.child_category),$scope.hours=[],$scope.minutes=[];for(var i=0;24>i;i++)$scope.hours.push(i);for(var i=0;60>i;i++)$scope.minutes.push(i);$scope.bill.date=$rootScope.current_bill.bill_time.split(" ")[0],$scope.bill.time.hour=parseInt($rootScope.current_bill.bill_time.split(" ")[1].split(":")[0]),$scope.bill.time.minute=parseInt($rootScope.current_bill.bill_time.split(" ")[1].split(":")[1]);for(var i=0;i<$rootScope.account_items.length&&$rootScope.account_items[i].account_id!=$rootScope.current_bill.account_id;i++);$rootScope.child_accounts=$rootScope.account_items[i].child_accounts,$scope.bill.account=$rootScope.current_bill.account_id,$scope.bill.child_account=$rootScope.current_bill.child_account_id,$scope.bill.location=$rootScope.current_bill.bill_location,$scope.bill.sum=parseFloat($rootScope.current_bill.bill_sum),$scope.bill.remarks=$rootScope.current_bill.bill_remarks}else{console.log("当前是新增操作"),$scope.bill_type=1,$scope.bill_type_text="记账-支出",Bill.getCategoryInfo(1).success(function(res){console.log(res),$rootScope.bill_category_items=res.bill_category_items,$rootScope.child_bill_categories=$rootScope.bill_category_items[0].child_bill_categories,$scope.bill.category=$rootScope.bill_category_items[0].bill_category_id,$scope.bill.child_category=$rootScope.bill_category_items[0].child_bill_categories[0].child_bill_category_id});var date=new Date;$scope.bill.date=date.getFullYear()+"-"+(parseInt(date.getMonth())+1)+"-"+date.getDate(),$scope.bill.time.hour=parseInt(date.getHours()),$scope.bill.time.minute=parseInt(date.getMinutes()),$scope.hours=[],$scope.minutes=[];for(var i=0;i<parseInt($scope.bill.time.hour)+1;i++)$scope.hours.push(i);console.log($scope.hours);for(var i=0;i<parseInt($scope.bill.time.minute)+1;i++)$scope.minutes.push(i);$scope.bill.location=$scope.bill.sum=$scope.bill.remarks=null}}),$scope.billAccountTypeChange=function(){for(var index=0,i=0;i<$rootScope.account_items.length;i++)if($scope.bill.account==$rootScope.account_items[i].account_id){index=i;break}console.log("index:"+index),$rootScope.child_accounts=$rootScope.account_items[index].child_accounts,$scope.bill.child_account=$rootScope.child_accounts[0].child_account_id},$scope.billCategoryTypeChange=function(){for(var index=0,i=0;i<$rootScope.bill_category_items.length;i++)if($scope.bill.category==$rootScope.bill_category_items[i].bill_category_id){index=i;break}console.log("index:"+index),$rootScope.child_bill_categories=$rootScope.bill_category_items[index].child_bill_categories,$scope.bill.child_category=$rootScope.child_bill_categories[0].child_bill_category_id},$scope.location_options_show=!1,$scope.add_bill_modal_click=function(){$scope.location_options_show=!1};var url="http://api.map.baidu.com/location/ip?ak="+baidu_ak+"&callback=JSON_CALLBACK",city_code=131;$http.jsonp(url).success(function(res){city_code=res.content.address_detail.city_code}),$scope.location_options=[];var baidu_suggestion_api_url="http://api.map.baidu.com/place/v2/suggestion";$scope.locationInputChange=function(){var url=baidu_suggestion_api_url+"?query="+$scope.bill.location+"&region="+city_code+"&ak="+baidu_ak+"&output=json&callback=JSON_CALLBACK";$http.jsonp(url).success(function(res){0==res.status?($scope.location_options_show=!0,$scope.location_options=res.result):console.log("获取位置列表失败！")})},$scope.selectLocation=function(location){$scope.bill.location=location,$scope.location_options_show=!1},$scope.addBill=function(){var bill={bill_type:$scope.bill_type,bill_category_id:$scope.bill.child_category,bill_account_id:$scope.bill.child_account,bill_time:$scope.bill.date+" "+$scope.bill.time.hour+":"+$scope.bill.time.minute,bill_location:$scope.bill.location,bill_sum:$scope.bill.sum,bill_remarks:$scope.bill.remarks};return $scope.bill.sum<0?void hMessage("金额不能为负！"):(console.log(bill),void Bill.add(bill).success(function(res){if(console.log(res),0===res.error){var bill_modal=UIkit.modal("#add-bill-modal");bill_modal.isActive()&&bill_modal.hide(),hMessage("账单添加成功！",2e3),Bill.getBillById(res.bill.bill_id).success(function(result){0===result.error?($rootScope.bills.push(result.bill),$rootScope.bill_tip="",$rootScope.bill_tip_show=!1):hMessage(result.msg)})}else hMessage(res.msg,2e3)}))},$scope.modifyBill=function(){if("modify_bill"==$rootScope.current_operation){var bill={bill_id:$rootScope.current_bill.bill_id,bill_type:$scope.bill_type,bill_category_id:$scope.bill.child_category,bill_account_id:$scope.bill.child_account,bill_time:$scope.bill.date+" "+$scope.bill.time.hour+":"+$scope.bill.time.minute,bill_location:$scope.bill.location,bill_sum:$scope.bill.sum,bill_remarks:$scope.bill.remarks};if($scope.bill.sum<0)return void hMessage("金额不能为负！");Bill.modify(bill).success(function(res){if(console.log(res),0===res.error){var bill_modal=UIkit.modal("#add-bill-modal");bill_modal.hide(),hMessage("账单修改成功！",2e3);for(var i=0;i<$rootScope.bills.length;i++)if($rootScope.bills[i].bill_id==$rootScope.current_bill.bill_id){Bill.getBillById($rootScope.current_bill.bill_id).success(function(res){0===res.error?$rootScope.bills[i]=res.bill:hMessage(res.msg)});break}}else hMessage(res.msg,2e3)})}},$scope.bill_type_switch_tip_show=!1,$scope.switchBillType=function(){"modify_bill"==$rootScope.current_operation&&($scope.bill_type_switch_tip_show=!0,$scope.bill_type_switch_tip="切换类型后账单<b>类别</b>可能需要修改！",$timeout(function(){$scope.bill_type_switch_tip_show=!1},4e3)),$rootScope.child_accounts=$rootScope.account_items[0].child_accounts,$scope.bill.account=$rootScope.account_items[0].account_id,$scope.bill.child_account=$rootScope.child_accounts[0].child_account_id,"outcome"==$scope.current_bill_view?(Bill.getCategoryInfo(2).success(function(res){console.log(res),$rootScope.bill_category_items=res.bill_category_items,$rootScope.child_bill_categories=$rootScope.bill_category_items[0].child_bill_categories,$scope.bill.category=$rootScope.bill_category_items[0].bill_category_id,$scope.bill.child_category=$rootScope.bill_category_items[0].child_bill_categories[0].child_bill_category_id}),$scope.bill_type=2,$rootScope.templates.bill_add=$rootScope.templates.bill+"/bill_add_income.html",$scope.current_bill_view=$rootScope.previous_view="income",$scope.bill_type_text="记账-收入"):(Bill.getCategoryInfo(1).success(function(res){console.log(res),$rootScope.bill_category_items=res.bill_category_items,$rootScope.child_bill_categories=$rootScope.bill_category_items[0].child_bill_categories,$scope.bill.category=$rootScope.bill_category_items[0].bill_category_id,$scope.bill.child_category=$rootScope.bill_category_items[0].child_bill_categories[0].child_bill_category_id}),$scope.bill_type=1,$rootScope.templates.bill_add=$rootScope.templates.bill+"/bill_add_outcome.html",$scope.current_bill_view=$rootScope.previous_view="outcome",$scope.bill_type_text="记账-支出")},$scope.backToDetail=function(){var bill_detail_modal=UIkit.modal("#bill-detail-modal");bill_detail_modal.show(),$rootScope.templates.bill_add=$rootScope.templates.bill+"/bill_details.html"},$scope.vAddCategory=function(previous_view){$rootScope.previous_view=previous_view,$rootScope.templates.bill_add=$rootScope.templates.add_category},$scope.vAddAccount=function(){$rootScope.templates.bill_add=$rootScope.templates.add_account}}),note.controller("c_add_bill_category",function($scope,$rootScope,$state,$http,Bill){$scope.ifAddSelfCategory=!1,$scope.add_self_category_btn_icon='<i class="uk-icon-toggle-off uk-icon-medium"></i>',$scope.add_category_title="outcome"==$rootScope.previous_view?"支出":"收入",$scope.bill_category.bill_category=$rootScope.bill_category_items[0].bill_category_id,$scope.switchAddSelfCategory=function(){$scope.ifAddSelfCategory=$scope.ifAddSelfCategory?!1:!0,$scope.ifAddSelfCategory?($scope.bill_category.bill_category="",$scope.add_self_category_btn_icon='<i class="uk-icon-toggle-on uk-icon-medium"></i>'):($scope.bill_category.bill_category=$rootScope.bill_category_items[0].bill_category_id,$scope.add_self_category_btn_icon='<i class="uk-icon-toggle-off uk-icon-medium"></i>')},$scope.addCategory=function(){var bill_type="outcome"==$rootScope.previous_view?1:2,is_self_defined=$scope.ifAddSelfCategory?1:0,categoryItem={is_self_defined:is_self_defined,bill_type:bill_type,bill_category:$scope.bill_category.bill_category,child_bill_category:$scope.bill_category.child_bill_category};Bill.addCategory(categoryItem).success(function(res){console.log(res),0===res.error?(hMessage("添加分类成功！",2e3),$rootScope.bill_category_items="outcome"==$rootScope.previous_view?Bill.getCategoryInfo(1).success(function(res){console.log(res),$rootScope.bill_category_items=res.bill_category_items,$rootScope.child_bill_categories=$rootScope.bill_category_items[0].child_bill_categories,$scope.bill_category.bill_category=$rootScope.bill_category_items[0].bill_category_id,$scope.bill.category=$rootScope.bill_category_items[0].bill_category_id,$scope.bill.child_category=$rootScope.bill_category_items[0].child_bill_categories[0].child_bill_category_id}):Bill.getCategoryInfo(2).success(function(res){console.log(res),$rootScope.bill_category_items=res.bill_category_items,$rootScope.child_bill_categories=$rootScope.bill_category_items[0].child_bill_categories,$scope.bill_category.bill_category=$rootScope.bill_category_items[0].bill_category_id,$scope.bill.category=$rootScope.bill_category_items[0].bill_category_id,$scope.bill.child_category=$rootScope.bill_category_items[0].child_bill_categories[0].child_bill_category_id})):hMessage(res.msg,2e3)})},$scope.backward=function(){$rootScope.templates.bill_add=$rootScope.templates.bill+"/bill_add_"+$rootScope.previous_view+".html"}}),note.controller("c_add_account",function($scope,$rootScope,$state,$http,Account){$scope.added_account=$rootScope.account_items[0].account_id,$scope.added_child_account_name="",$scope.added_child_account_balance=$scope.added_child_account_remarks="",$scope.add_self_account_btn_icon='<i class="uk-icon-toggle-off uk-icon-medium"></i>',$scope.ifAddSelfAccount=!1,$scope.switchSelfAccount=function(){$scope.ifAddSelfAccount=$scope.ifAddSelfAccount?!1:!0,$scope.ifAddSelfAccount?($scope.added_account="",$scope.add_self_account_btn_icon='<i class="uk-icon-toggle-on uk-icon-medium"></i>'):($scope.added_account=$rootScope.account_items[0].account_id,$scope.add_self_account_btn_icon='<i class="uk-icon-toggle-off uk-icon-medium"></i>')},$scope.addAccount=function(){var is_self_defined=$scope.ifAddSelfAccount?1:0,data={is_self_defined:is_self_defined,account:$scope.added_account,child_account_name:$scope.added_child_account_name,child_account_balance:$scope.added_child_account_balance,child_account_remarks:$scope.added_child_account_remarks};console.log(data),$http({method:"POST",url:home_path+"/Account/add_account.html",data:{is_self_defined:is_self_defined,account:$scope.added_account,
child_account_name:$scope.added_child_account_name,child_account_balance:$scope.added_child_account_balance,child_account_remarks:$scope.added_child_account_remarks}}).success(function(res){0===res.error&&(Account.getBasicAccountItems().success(function(res){$rootScope.account_items=res.account_items,$rootScope.child_accounts=$rootScope.account_items[0].child_accounts,$scope.added_account=$rootScope.account_items[0].account_id,$scope.bill.account=$rootScope.account_items[0].account_id,$scope.bill.child_account=$rootScope.account_items[0].child_accounts[0].child_account_id}),hMessage("添加成功！"))})},$scope.backward=function(){$rootScope.templates.bill_add=$rootScope.templates.bill+"/bill_add_"+$rootScope.previous_view+".html"}}),note.controller("c_bill_details",function($scope,$rootScope,$state,$http,Bill){$scope.deleteBill=function(){var bill_id=null==arguments[0]?$rootScope.current_bill.bill_id:arguments[0];confirm("你确定要删除该账单["+bill_id+"]？本操作不可撤销！")&&Bill["delete"](bill_id).success(function(res){if(console.log(res),0===res.error){var bill_detail_modal=UIkit.modal("#bill-detail-modal");bill_detail_modal.hide(),hMessage("账单删除成功！",2e3),document.getElementById("bill_"+bill_id).parentNode.removeChild(document.getElementById("bill_"+bill_id))}else hMessage(res.msg,2e3)})},$scope.vModifyBill=function(){var add_bill_modal=UIkit.modal("#add-bill-modal");add_bill_modal.show(),$rootScope.templates.bill_add=$rootScope.templates.bill+"/bill_add_outcome.html",$rootScope.current_operation="modify_bill",$rootScope.bill_operation_trigger=0==$rootScope.bill_operation_trigger?1:0}}),note.controller("c_bill_query",function($scope,$rootScope,$state,Bill,Account){$scope.bill_query_tip_show=!1,$scope.bill_query_tip="",$scope.bill_type=3,$scope.start_date=$scope.end_date=null,$scope.bill_account={account:0,child_account:0},$scope.bill_account_selected=!1,$scope.bill_category_selected=!1,$scope.bill_category={category:0,child_category:0},$rootScope.bills={},Account.getBasicAccountItems().success(function(res){$scope.account_items=res.account_items,$scope.child_accounts=$scope.account_items[0].child_accounts,$scope.bill_account.account=$scope.account_items[0].account_id,$scope.bill_account.child_account=$scope.account_items[0].child_accounts[0].child_account_id}),Bill.getCategoryInfo(1).success(function(res){console.log(res),$scope.bill_category_items=res.bill_category_items,$scope.child_bill_categories=$scope.bill_category_items[0].child_bill_categories,$scope.bill_category.category=$scope.bill_category_items[0].bill_category_id,$scope.bill_category.child_category=$scope.bill_category_items[0].child_bill_categories[0].child_bill_category_id}),$scope.$watch("bill_type",function(newValue,oldValue){console.log("bill type changed:"+newValue),newValue%2!==0?Bill.getCategoryInfo(1).success(function(res){console.log(res),$scope.bill_category_items=res.bill_category_items,$scope.child_bill_categories=$scope.bill_category_items[0].child_bill_categories,$scope.bill_category.category=$scope.bill_category_items[0].bill_category_id,$scope.bill_category.child_category=$scope.bill_category_items[0].child_bill_categories[0].child_bill_category_id}):Bill.getCategoryInfo(2).success(function(res){console.log(res),$scope.bill_category_items=res.bill_category_items,$scope.child_bill_categories=$scope.bill_category_items[0].child_bill_categories,$scope.bill_category.category=$scope.bill_category_items[0].bill_category_id,$scope.bill_category.child_category=$scope.bill_category_items[0].child_bill_categories[0].child_bill_category_id})}),$scope.$watch("bill_account.account",function(newValue,oldValue){for(var i=0;i<$scope.account_items.length;i++)newValue==$scope.account_items[i].account_id&&($scope.child_accounts=$scope.account_items[i].child_accounts,$scope.bill_account.child_account=$scope.account_items[i].child_accounts[0].child_account_id)}),$scope.$watch("bill_category.category",function(newValue,oldValue){for(var i=0;i<$scope.bill_category_items.length;i++)newValue==$scope.bill_category_items[i].bill_category_id&&($scope.child_bill_categories=$scope.bill_category_items[i].child_bill_categories,$scope.bill_category.child_category=$scope.bill_category_items[i].child_bill_categories[0].child_bill_category_id)}),$scope.query=function(){$scope.bill_query_tip_show=!0,$scope.bill_query_tip="<i class='uk-icon-spinner'></i> 拼命查询中...";var queryCdt={start_date:$scope.start_date,end_date:$scope.end_date,bill_type:$scope.bill_type,bill_account:$scope.bill_account_selected?$scope.bill_account.child_account:null,bill_category:$scope.bill_category_selected&&3!==$scope.bill_type?$scope.bill_category.child_category:null};console.log(queryCdt),Bill.query(queryCdt).success(function(res){console.log(res),0===res.error?($rootScope.bills=res.bills,$rootScope.bills.length?$scope.bill_query_tip_show=!1:$scope.bill_query_tip="<i class='uk-icon-warning'></i> 查询不到符合条件的记录！"):$scope.bill_query_tip="<i class='uk-icon-warning'></i> "+res.msg})},$scope.billView=function(index){$rootScope.current_bill=$rootScope.bills[index];var bill_detail_modal=UIkit.modal("#bill-detail-modal");bill_detail_modal.show()}}),note.controller("c_bill_category",function($scope,$rootScope,$state,Bill){$scope.bill_category_type=1,$scope.bill_category_title="支出分类",$scope.bill_category_items={},$scope.is_self_defined=!1,$scope.toggle_type="off",$scope.added_bill_category="",$scope.added_child_bill_category="",$scope.current_bill_category={},$scope.current_child_bill_category={},$scope.modified_bill_category=$scope.modified_child_bill_category_name=$scope.modified_child_bill_category_balance=$scope.modified_child_bill_category_remarks="",Bill.getCategoryInfo(1).success(function(res){console.log(res),0===res.error&&($scope.bill_category_items=res.bill_category_items,$scope.added_bill_category=$scope.bill_category_items[0].bill_category_id)}),$scope.switchCategoryType=function(){$scope.bill_category_type=1==$scope.bill_category_type?2:1,$scope.bill_category_title="支出分类"==$scope.bill_category_title?"收入分类":"支出分类",Bill.getCategoryInfo($scope.bill_category_type).success(function(res){console.log(res),0===res.error&&($scope.bill_category_items=res.bill_category_items,$scope.added_bill_category=$scope.bill_category_items[0].bill_category_id)})},$scope.updateCategory=function(){Bill.getCategoryInfo($scope.bill_category_type).success(function(res){console.log(res),0===res.error&&($scope.bill_category_items=res.bill_category_items,$scope.added_bill_category=$scope.bill_category_items[0].bill_category_id)})},$scope.vAddCategory=function(){UIkit.modal("#bill_category_add_modal").show()},$scope.addCategory=function(){var is_self_defined=$scope.is_self_defined?1:0,categoryItem={is_self_defined:is_self_defined,bill_type:$scope.bill_category_type,bill_category:$scope.added_bill_category,child_bill_category:$scope.added_child_bill_category};console.log(categoryItem),Bill.addCategory(categoryItem).success(function(res){0===res.error?($scope.updateCategory(),hMessage("添加分类成功！")):hMessage(res.msg)})},$scope.switchAddSelfCategory=function(){$scope.is_self_defined?($scope.toggle_type="off",$scope.added_bill_category=$scope.bill_category_items[0].bill_category.bill_category_id):($scope.toggle_type="on",$scope.added_bill_category=""),$scope.is_self_defined=$scope.is_self_defined?!1:!0},$scope.vModifyBillCategory=function(index){$scope.current_bill_category=$scope.bill_category_items[index].bill_category,UIkit.modal("#bill_category_modify_modal").show()},$scope.modifyBillCategory=function(){console.log("修改一级分类："),console.log($scope.current_bill_category),Bill.modifyCategory($scope.current_bill_category.bill_category_id,$scope.current_bill_category.bill_category_name).success(function(res){console.log(res),0===res.error?($scope.updateCategory(),hMessage("修改成功！")):hMessage(res.msg)})},$scope.deleteBillCategory=function(bill_category_id){confirm("你确定要删除该一级分类-"+bill_category_id+"(该分类下的所有二级分类和所有账单也将被删除！！)??")&&Bill.deleteCategory(bill_category_id).success(function(res){0===res.error?($scope.updateCategory(),hMessage("删除分类成功！")):hMessage(res.msg)})},$scope.vModifyChildBillCategory=function(index){for(var current_child_bill_category_select=document.querySelector("#bill_category_item_"+index+" select"),current_child_bill_category_id=current_child_bill_category_select.options[current_child_bill_category_select.selectedIndex].value.split(":")[1],i=0;i<$scope.bill_category_items[index].child_bill_categories.length;i++)$scope.bill_category_items[index].child_bill_categories[i].child_bill_category_id==current_child_bill_category_id&&($scope.current_child_bill_category=$scope.bill_category_items[index].child_bill_categories[i]);UIkit.modal("#child_bill_category_modify_modal").show()},$scope.modifyChildBillCategory=function(){console.log("修改二级分类："),console.log($scope.current_child_bill_category),Bill.modifyChildCategory($scope.current_child_bill_category.child_bill_category_id,$scope.current_child_bill_category.child_bill_category_name).success(function(res){console.log(res),0===res.error?($scope.updateCategory(),hMessage("修改成功！")):hMessage(res.msg)})},$scope.deleteChildBillCategory=function(index){if(confirm("你确定要删除该二级分类(属于该分类的账单也会被一并删除！)??")){var current_child_bill_category_select=document.querySelector("#bill_category_item_"+index+" select"),current_child_bill_category_id=current_child_bill_category_select.options[current_child_bill_category_select.selectedIndex].value.split(":")[1];Bill.deleteChildCategory(current_child_bill_category_id).success(function(res){0===res.error?($scope.updateCategory(),hMessage("删除分类成功！")):hMessage(res.msg)})}}}),note.controller("c_accounts",function($scope,$rootScope,$state,Account){$scope.current_account={},$scope.current_accounts_tab="account_manage",Account.getBasicAccountItems().success(function(res){$rootScope.account_items=res.account_items,$rootScope.child_accounts=$rootScope.account_items[0].child_accounts}),setTitle("随手记-账户"),$state.go("account_manage"),$scope.switchAccountsTab=function(tab){$scope.current_accounts_tab=tab,$state.go(tab,{reload:!0})}}),note.controller("c_account_view",function($scope,$rootScope,$state,Account){$scope.current_account={},$scope.account_bills_tip_show=!1,Account.getAccount($rootScope.current_account_id).success(function(res){if(console.log(res),0===res.error){$scope.current_account.account=res.account,$scope.current_account.flow_in=0,$scope.current_account.flow_out=0,$scope.current_account.balance=parseFloat($scope.current_account.account.child_account_balance);for(var i=0;i<$scope.current_account.account.bills.length;i++)1==$scope.current_account.account.bills[i].bill_type?$scope.current_account.flow_out+=parseFloat($scope.current_account.account.bills[i].bill_sum):$scope.current_account.flow_in+=parseFloat($scope.current_account.account.bills[i].bill_sum);$scope.account_bills_tip_show=i?!1:!0,$scope.current_account.balance+=$scope.current_account.flow_in-$scope.current_account.flow_out,console.log($scope.current_account)}else hMessage(res.msg)}),$scope.showBillDetail=function(index){},$scope.backward=function(){$state.go("account_manage")}}),note.controller("c_account_manage",function($scope,$rootScope,$state,Account){$scope.start_date=$scope.end_date=null,$scope.account_items={},$scope.is_self_defined=!1,$scope.toggle_type="off",$scope.added_account="",$scope.modified_child_account={},$scope.modified_account={},$scope.added_child_account={},$scope.sum={},$scope.updateAccountList=function(end_date){if(end_date)var cdt={end_date:end_date};Account.getDetailedAccountItems(cdt).success(function(res){console.log(res),0===res.error?($scope.account_items=res.account_list,$scope.added_account=$scope.account_items[0].account_id,$scope.sumAccounts($scope.account_items)):hMessage(res.msg)})},$scope.updateAccountList(),$scope.sumAccounts=function(account_items){$scope.sum.balance=$scope.sum.flow_in=$scope.sum.flow_out=0;for(var i=0;i<account_items.length;i++)for(var j=0;j<account_items[i].child_accounts.length;j++)$scope.sum.flow_in+=parseFloat(account_items[i].child_accounts[j].flow_in),$scope.sum.flow_out+=parseFloat(account_items[i].child_accounts[j].flow_out),$scope.sum.balance+=parseFloat(account_items[i].child_accounts[j].child_account_balance);$scope.sum.balance+=$scope.sum.flow_in-$scope.sum.flow_out},$scope.query=function(){console.log("end_date:"+$scope.end_date),$scope.updateAccountList($scope.end_date)},$scope.vAddAccount=function(){UIkit.modal("#account_add_modal").show()},$scope.switchAddSelfAccount=function(){$scope.is_self_defined=$scope.is_self_defined?!1:!0,$scope.toggle_type="on"==$scope.toggle_type?"off":"on",$scope.added_account=""==$scope.added_account?$scope.account_items[0].account_id:""},$scope.addAccount=function(){var is_self_defined=$scope.is_self_defined?1:0,account={is_self_defined:is_self_defined,account:$scope.added_account,child_account_name:$scope.added_child_account.name,child_account_balance:$scope.added_child_account.default_balance,child_account_remarks:$scope.added_child_account.remarks};console.log(account),Account.add(account).success(function(res){0===res.error?($scope.updateAccountList(),hMessage("账户添加成功！")):hMessage(res.msg)})},$scope.vModifyAccount=function(account_item){$scope.modified_account=account_item,console.log($scope.modified_account),UIkit.modal("#account_modify_modal").show()},$scope.vModifyChildAccount=function(child_account){$scope.modified_child_account=child_account,$scope.modified_child_account.balance=parseFloat($scope.modified_child_account.child_account_balance)+$scope.modified_child_account.flow_in-$scope.modified_child_account.flow_out,console.log($scope.modified_child_account),UIkit.modal("#child_account_modify_modal").show()},$scope.modifyAccount=function(){Account.modifyAccount($scope.modified_account).success(function(res){0===res.error?($scope.updateAccountList(),hMessage("账户修改成功！")):hMessage(res.msg)})},$scope.modifyChildAccount=function(){var added_num=$scope.modified_child_account.balance-(parseFloat($scope.modified_child_account.child_account_balance)+($scope.modified_child_account.flow_in-$scope.modified_child_account.flow_out));$scope.modified_child_account.child_account_balance=parseFloat($scope.modified_child_account.child_account_balance)+added_num,console.log("added_num"+added_num),Account.modifyChildAccount($scope.modified_child_account).success(function(res){0===res.error?($scope.updateAccountList(),hMessage("账户修改成功！")):hMessage(res.msg)})},$scope.deleteAccount=function(account_id){confirm("你确定要删除该一级账户??该账户下所有的子账户及其账单都将被删除！！")&&(console.log("删除一级账户:"+account_id),Account["delete"](account_id,1).success(function(res){0===res.error?($scope.updateAccountList(),hMessage("账户删除成功！")):hMessage(res.msg)}))},$scope.deleteChildAccount=function(child_account_id){confirm("你确定要删除该二级账户??该账户下所有的账单都将被删除！！")&&(console.log("删除二级账户:"+child_account_id),Account["delete"](child_account_id,2).success(function(res){0===res.error?($scope.updateAccountList(),hMessage("账户删除成功！")):hMessage(res.msg)}))},$scope.viewChildAccount=function(account_id){$rootScope.current_account_id=account_id,console.log("account_id:"+account_id),$state.go("account")}}),note.controller("c_account_transfer",function($scope,$rootScope,$state,Account){$scope.out_account={items:{},child_accounts:{},account:null,child_account:null},$scope.in_account={items:{},child_accounts:{},account:null,child_account:null},$scope.transfer_num=null,$scope.transfer_remarks=null,Account.getBasicAccountItems().success(function(res){$scope.out_account.account_items=$scope.in_account.account_items=res.account_items,$scope.out_account.child_accounts=$scope.in_account.child_accounts=res.account_items[0].child_accounts,$scope.out_account.account=$scope.in_account.account=$rootScope.account_items[0].account_id,$scope.out_account.child_account=$scope.in_account.child_account=$rootScope.child_accounts[0].child_account_id,$scope.$watch("out_account.account",function(newV,oldV){for(var i=0;i<$scope.out_account.account_items.length;i++)newV===$scope.out_account.account_items[i].account_id&&($scope.out_account.child_accounts=$scope.out_account.account_items[i].child_accounts,$scope.out_account.child_account=$scope.out_account.child_accounts[0].child_account_id)}),$scope.$watch("in_account.account",function(newV,oldV){for(var i=0;i<$scope.in_account.account_items.length;i++)newV===$scope.in_account.account_items[i].account_id&&($scope.in_account.child_accounts=$scope.in_account.account_items[i].child_accounts,$scope.in_account.child_account=$scope.in_account.child_accounts[0].child_account_id)})}),$scope.transfer=function(){var cdt={out_account:$scope.out_account.child_account,in_account:$scope.in_account.child_account,transfer_num:$scope.transfer_num,transfer_remarks:$scope.transfer_remarks};return cdt.out_account===cdt.in_account?void hMessage("不能在同一个账户上进行转账！"):"number"!=typeof cdt.transfer_num?void hMessage("金额只能为数字！"):cdt.transfer_num<=0?void hMessage("金额只能为正数！"):(console.log(cdt),void Account.transfer(cdt).success(function(res){console.log(res),hMessage(0===res.error?"转账成功！":res.msg)}))}}),note.controller("c_charts",function($scope,$rootScope,$http,Charts,$state){$state.go("budget"),$scope.current_charts_tab="budget",$scope.switchChartsTab=function(tab){$scope.current_charts_tab=tab,$state.go(tab)}}),note.controller("c_charts_distribute",function($scope,$rootScope,$http,Charts,$state){$scope.distribute_option="0",$scope.start_date=$rootScope.sdate,$scope.end_date=$rootScope.edate,$scope.charts_distribute_tip='<i class="uk-icon-warning"></i> 请输入查询条件查询！',require(["echarts","echarts/chart/pie"],function(ec){$scope.income_distribute_chart=ec.init(document.getElementById("charts-distribute-pie-income")),$scope.outcome_distribute_chart=ec.init(document.getElementById("charts-distribute-pie-outcome")),$scope.query=function(){$scope.income_distribute_chart.clear(),$scope.outcome_distribute_chart.clear(),$scope.income_distribute_chart_options=$rootScope.clone($rootScope.pie_options),$scope.income_distribute_chart_options.title.text="收入分布图",$scope.income_distribute_chart_options.title.subtext="0"==$scope.distribute_option?"账户":"分类",$scope.income_distribute_chart_options.series[0].name="0"==$scope.distribute_option?"账户":"分类",$scope.outcome_distribute_chart_options=$rootScope.clone($rootScope.pie_options),$scope.outcome_distribute_chart_options.title.text="支出分布图",$scope.outcome_distribute_chart_options.title.subtext="0"==$scope.distribute_option?"账户":"分类",$scope.outcome_distribute_chart_options.series[0].name="0"==$scope.distribute_option?"账户":"分类",$scope.outcome_distribute_chart_options.legend.data=[],$scope.outcome_distribute_chart_options.series[0].data=[],$scope.income_distribute_chart_options.legend.data=[],$scope.income_distribute_chart_options.series[0].data=[];var cdt={start_date:$scope.start_date,end_date:$scope.end_date,distribute:$scope.distribute_option};Charts.getDistributeData(cdt).success(function(res){if(console.log(cdt),0===res.error){if("0"==$scope.distribute_option)for(var i=0;i<res.bills.length;i++)1==res.bills[i].bill_type?($scope.outcome_distribute_chart_options.legend.data.push(res.bills[i].child_account_name),$scope.outcome_distribute_chart_options.series[0].data.push({value:res.bills[i].bills_sum,name:res.bills[i].child_account_name})):($scope.income_distribute_chart_options.legend.data.push(res.bills[i].child_account_name),$scope.income_distribute_chart_options.series[0].data.push({value:res.bills[i].bills_sum,name:res.bills[i].child_account_name}));else for(var i=0;i<res.bills.length;i++)1==res.bills[i].bill_type?($scope.outcome_distribute_chart_options.legend.data.push(res.bills[i].child_bill_category_name),$scope.outcome_distribute_chart_options.series[0].data.push({value:res.bills[i].bills_sum,name:res.bills[i].child_bill_category_name})):($scope.income_distribute_chart_options.legend.data.push(res.bills[i].child_bill_category_name),$scope.income_distribute_chart_options.series[0].data.push({value:res.bills[i].bills_sum,name:res.bills[i].child_bill_category_name}));i?($scope.income_distribute_chart.dispose(),$scope.outcome_distribute_chart.dispose(),$scope.income_distribute_chart=echarts.init(document.getElementById("charts-distribute-pie-income")),$scope.outcome_distribute_chart=echarts.init(document.getElementById("charts-distribute-pie-outcome")),$scope.charts_distribute_tip=""):$scope.charts_distribute_tip='<i class="uk-icon-warning"></i> 未查到相关信息！',$scope.income_distribute_chart.setOption($scope.income_distribute_chart_options),$scope.outcome_distribute_chart.setOption($scope.outcome_distribute_chart_options)}else hMessage(res.msg)})},$scope.query()})}),note.controller("c_charts_compare",function($scope,$rootScope,$http,Charts,$state){$scope.start_date=$rootScope.sdate,$scope.end_date=$rootScope.edate,$scope.charts_compare_tip='<i class="uk-icon-warning"></i> 请输入查询条件查询！',require(["echarts","echarts/chart/pie"],function(ec){$scope.compare_chart=ec.init(document.getElementById("charts-compare-pie")),$scope.query=function(){$scope.compare_chart.clear(),$scope.compare_chart_options=$rootScope.clone($rootScope.pie_options),$scope.compare_chart_options.title.text="收支对比图",$scope.compare_chart_options.series[0].name="金额",$scope.compare_chart_options.legend.data=[],$scope.compare_chart_options.series[0].data=[];var cdt={start_date:$scope.start_date,end_date:$scope.end_date};Charts.getCompareData(cdt).success(function(res){if(console.log(res),0===res.error){for(var i=0;i<res.bills.length;i++)1==res.bills[i].bill_type?($scope.compare_chart_options.legend.data.push("支出"),$scope.compare_chart_options.series[0].data.push({value:res.bills[i].bills_sum,name:"支出"})):($scope.compare_chart_options.legend.data.push("收入"),$scope.compare_chart_options.series[0].data.push({value:res.bills[i].bills_sum,name:"收入"}));i?($scope.compare_chart.dispose(),$scope.compare_chart=echarts.init(document.getElementById("charts-compare-pie")),$scope.charts_compare_tip=""):$scope.charts_compare_tip='<i class="uk-icon-warning"></i> 未查到相关信息！',$scope.compare_chart.setOption($scope.compare_chart_options)}else hMessage(res.msg)})},$scope.query()})}),note.controller("c_charts_trend",function($scope,$rootScope,$http,Charts,$state){$scope.time_unit="1",$scope.start_date=$rootScope.sdate,$scope.end_date=$rootScope.edate,$scope.charts_trend_tip='<i class="uk-icon-warning"></i> 请输入查询条件查询！',require(["echarts","echarts/chart/line"],function(ec){$scope.outcome_trend_chart=ec.init(document.getElementById("charts-trend-line-outcome")),$scope.income_trend_chart=ec.init(document.getElementById("charts-trend-line-income")),$scope.query=function(){switch($scope.outcome_trend_chart.clear(),$scope.income_trend_chart.clear(),$scope.outcome_trend_chart_options=$rootScope.clone($rootScope.line_options),$scope.income_trend_chart_options=$rootScope.clone($rootScope.line_options),$scope.inout_trend_chart_options=$rootScope.clone($rootScope.line_options),parseInt($scope.time_unit)){case 1:$scope.outcome_trend_chart_options.title.subtext="单位:天",$scope.income_trend_chart_options.title.subtext="单位:天";break;case 2:$scope.outcome_trend_chart_options.title.subtext="单位:月",$scope.income_trend_chart_options.title.subtext="单位:月";break;case 3:$scope.outcome_trend_chart_options.title.subtext="单位:年",$scope.income_trend_chart_options.title.subtext="单位:年"}$scope.outcome_trend_chart_options.title.text="支出趋势图",$scope.outcome_trend_chart_options.legend.data=["支出"],$scope.outcome_trend_chart_options.xAxis[0].data=[],$scope.outcome_trend_chart_options.series[0]={},$scope.outcome_trend_chart_options.series[0].name="支出",$scope.outcome_trend_chart_options.series[0].type="line",$scope.outcome_trend_chart_options.series[0].data=[],$scope.income_trend_chart_options.title.text="收入趋势图",$scope.income_trend_chart_options.legend.data=["收入"],$scope.income_trend_chart_options.xAxis[0].data=[],$scope.income_trend_chart_options.series[0]={},$scope.income_trend_chart_options.series[0].name="收入",$scope.income_trend_chart_options.series[0].type="line",$scope.income_trend_chart_options.series[0].data=[];var cdt={start_date:$scope.start_date,end_date:$scope.end_date,time_unit:$scope.time_unit};Charts.getTrendData(cdt).success(function(res){if(console.log(res),0===res.error){for(var i=0;i<res.outcome_bills.length;i++)$scope.outcome_trend_chart_options.xAxis[0].data.push(res.outcome_bills[i].bill_time),$scope.outcome_trend_chart_options.series[0].data.push(res.outcome_bills[i].bill_sum);for(var j=0;j<res.income_bills.length;j++)$scope.income_trend_chart_options.xAxis[0].data.push(res.income_bills[j].bill_time),$scope.income_trend_chart_options.series[0].data.push(res.income_bills[j].bill_sum);$scope.charts_trend_tip=i||j?"":'<i class="uk-icon-warning"></i> 未查到相关信息！',$scope.outcome_trend_chart.setOption($scope.outcome_trend_chart_options),$scope.income_trend_chart.setOption($scope.income_trend_chart_options)}else hMessage(res.msg)})},$scope.query()})}),note.controller("c_property_distribute",function($scope,$rootScope,$http,Charts,$state){$scope.end_date=$rootScope.edate,$scope.charts_property_distribute_tip='<i class="uk-icon-warning"></i> 请输入查询条件查询！',require(["echarts","echarts/chart/pie"],function(ec){$scope.property_distribute_chart=ec.init(document.getElementById("charts-property-distribute-pie")),$scope.liabilities_distribute_chart=ec.init(document.getElementById("charts-liabilities-distribute-pie")),$scope.query=function(){$scope.property_distribute_chart.clear(),$scope.liabilities_distribute_chart.clear(),$scope.property_distribute_chart_options=$rootScope.clone($rootScope.pie_options),$scope.liabilities_distribute_chart_options=$rootScope.clone($rootScope.pie_options),$scope.property_distribute_chart_options.title.text="资产分布图",$scope.liabilities_distribute_chart_options.title.text="负债分布图",$scope.property_distribute_chart_options.legend.data=[],$scope.property_distribute_chart_options.series[0]={},$scope.property_distribute_chart_options.series[0].name="账户资产",$scope.property_distribute_chart_options.series[0].type="pie",$scope.property_distribute_chart_options.series[0].data=[],$scope.liabilities_distribute_chart_options.legend.data=[],$scope.liabilities_distribute_chart_options.series[0]={},$scope.liabilities_distribute_chart_options.series[0].name="账户负债",$scope.liabilities_distribute_chart_options.series[0].type="pie",$scope.liabilities_distribute_chart_options.series[0].data=[];var cdt={end_date:$scope.end_date};Charts.getPropertyDistributeData(cdt).success(function(res){if(console.log(res),0===res.error){for(var count1=count2=0,i=0,ilen=res.account_items.length;ilen>i;i++)for(var j=0,jlen=res.account_items[i].child_accounts.length;jlen>j;j++){var balance=parseInt(res.account_items[i].child_accounts[j].child_account_balance)+res.account_items[i].child_accounts[j].flow_in-res.account_items[i].child_accounts[j].flow_out;console.log("balance:"+balance);var name=res.account_items[i].child_accounts[j].child_account_name;balance>0?($scope.property_distribute_chart_options.legend.data[count1++]=name,$scope.property_distribute_chart_options.series[0].data.push({value:Math.abs(balance),name:name})):0>balance&&($scope.liabilities_distribute_chart_options.legend.data[count2++]=name,$scope.liabilities_distribute_chart_options.series[0].data.push({value:Math.abs(balance),name:name}))}$scope.charts_property_distribute_tip=i?"":'<i class="uk-icon-warning"></i> 未查到相关信息！',$scope.property_distribute_chart.setOption($scope.property_distribute_chart_options),$scope.liabilities_distribute_chart.setOption($scope.liabilities_distribute_chart_options)}else hMessage(res.msg)})},$scope.query()})}),note.controller("c_property_trend",function($scope,$rootScope,$http,Charts,$state){$scope.end_date=$rootScope.edate,$scope.charts_property_trend_tip='<i class="uk-icon-warning"></i> 请输入查询条件查询！',require(["echarts","echarts/chart/line"],function(ec){$scope.property_trend_chart=ec.init(document.getElementById("charts-property-trend-line")),$scope.query=function(){$scope.charts_property_trend_tip='<i class="uk-icon-spinner"></i> 正在获取数据...',$scope.property_trend_chart.clear(),$scope.property_trend_chart_options=$rootScope.clone($rootScope.line_options),$scope.property_trend_chart_options.title.text="资产趋势图",$scope.property_trend_chart_options.title.subtext="单位:月",$scope.property_trend_chart_options.legend.data=["总资产","负债资产","净资产"],$scope.property_trend_chart_options.xAxis[0].data=[],$scope.property_trend_chart_options.series[0]={},$scope.property_trend_chart_options.series[0].name="总资产",$scope.property_trend_chart_options.series[0].type="line",$scope.property_trend_chart_options.series[0].data=[],$scope.property_trend_chart_options.series[1]={},$scope.property_trend_chart_options.series[1].name="负债资产",$scope.property_trend_chart_options.series[1].type="line",$scope.property_trend_chart_options.series[1].data=[],$scope.property_trend_chart_options.series[2]={},$scope.property_trend_chart_options.series[2].name="净资产",$scope.property_trend_chart_options.series[2].type="line",$scope.property_trend_chart_options.series[2].data=[];var cdt={end_date:$scope.end_date};Charts.getPropertyTrendData(cdt).success(function(res){if(console.log(res),0===res.error){for(var i=res.datas.length-1;i>=0;i--){for(var net_asset=liabilities=property=0,j=0,jlen=res.datas[i].length;jlen>j;j++){var balance=parseInt(res.datas[i][j].account_balance)+res.datas[i][j].flow_in-res.datas[i][j].flow_out;balance>0?property+=parseInt(balance):0>balance&&(liabilities+=balance)}net_asset=property+liabilities,$scope.property_trend_chart_options.series[0].data.push(property),$scope.property_trend_chart_options.series[1].data.push(liabilities),$scope.property_trend_chart_options.series[2].data.push(net_asset),$scope.property_trend_chart_options.xAxis[0].data.push(res.dates[i].slice(0,res.dates[i].lastIndexOf("-")))}$scope.charts_property_trend_tip="",$scope.property_trend_chart.setOption($scope.property_trend_chart_options)}})},$scope.query()})}),note.controller("c_chart_budget",function($scope,$rootScope,$http,Charts,$state){$scope.budget_num=null,$scope.budget={budget_num:0,outcome_num:0,budget_id:null},$scope.modified_budget_num=0,$scope.proportion=0,$scope.charts_budget_tip="",$scope.updateBudget=function(){$scope.charts_budget_tip='<i class="uk-icon-spinner"></i> 正在获取数据...',Charts.getBudgetData().success(function(res){console.log(res),0===res.error?($scope.budget.budget_num=parseFloat(res.budget_num),$scope.budget.outcome_num=parseFloat(res.outcome_num),$scope.budget.budget_id=res.budget_id,$scope.proportion=100*$scope.budget.outcome_num/$scope.budget.budget_num,$scope.charts_budget_tip=""):$scope.charts_budget_tip=res.msg}).error(function(data,state){console.log(data)})},$scope.updateBudget(),$scope.modifyBudget=function(){if($scope.modified_budget_num>0){var cdt={budget_id:$scope.budget.budget_id,budget_num:$scope.modified_budget_num};console.log(cdt),Charts.modifyBudget(cdt).success(function(res){console.log(res),0===res.error?(hMessage("修改成功！"),$scope.updateBudget()):hMessage(res.msg)})}else hMessage("预算数目必须为正数！")}}),note.controller("c_user",function($scope,$state,$rootScope){$state.go("basicInfo"),$rootScope.current_user_tab="basicInfo",$scope.switchUserTab=function(tab){$rootScope.current_user_tab=tab,$state.go(tab)}}),note.controller("c_user_basicInfo",function($scope,$state,$rootScope,ipCookie,User){$rootScope.current_user_tab="basicInfo",User.getBasicInfo().success(function(res){if(0===res.error){$rootScope.user={},$rootScope.user.name=res.user.user_name,$rootScope.username_text='<i class="uk-icon-user"></i> '+res.user.user_name,$rootScope.user.email=res.user.user_email;var pattern=/^(https|http|www)/g;$rootScope.user.avatar=pattern.test(res.user.user_avatar)?res.user.user_avatar:public_path+"/img/avatar/"+res.user.user_avatar}}),$scope.logout=function(){User.logout().success(function(res){0===res.error?(hMessage("退出登陆成功！",1200),ipCookie("is_logined",null),$rootScope.login_register_show=!0,$rootScope.user_show=!1,$rootScope.username_text="",setTimeout(function(){$state.go("login")},1200)):hMessage(res.msg);

})},$scope.modifyUserInfo=function(){var userInfo_modal=UIkit.modal("#modify-userInfo-modal");userInfo_modal.isActive()?userInfo_modal.hide():userInfo_modal.show()}}),note.controller("c_user_modifyPasswd",function($scope,$state,$rootScope,$timeout,User){$rootScope.current_user_tab="modifyPasswd",$scope.old_password=$scope.new_password=$scope.password_confirm="",$scope.resetPassword=function(){if(checkEmpty($scope.old_password)||checkEmpty($scope.new_password)||checkEmpty($scope.password_confirm))return void hMessage("密码不能为空(不能包含空格等非显示字符)！");if($scope.new_password.length<6&&$scope.new_password.length>0)return void hMessage("请输入六位以上的密码！");if($scope.new_password!==$scope.password_confirm)return void hMessage("新密码与确认密码不相等！");var passwordInfo={old_password:$scope.old_password,new_password:$scope.new_password,password_confirm:$scope.password_confirm};User.modifyPassword(passwordInfo).success(function(res){0===res.error?(hMessage("密码修改成功，请使用新的密码登陆！",2e3),$timeout(function(){$state.go("login")},2e3)):hMessage(res.msg,2e3)})}}),note.controller("c_modify_userInfo_modal",function($scope,$state,$rootScope,$interval,ipCookie,User){$scope.avatar_upload_url="http://localhost/M-Note/index.php/Home/User/upload_user_avatar.html",$scope.user_name=$scope.user_email="",$scope.uploadAvatarBtn="上传头像",$scope.uploadUserAvatar=function(){var uploadable=!0,checkTime=200,imgFile=document.getElementById("user_avatar_img").files[0];if(null==imgFile)hMessage("请先选择图片！"),uploadable=!1;else{"image/jpeg"!=imgFile.type&&"image/jpg"!=imgFile.type&&"image/png"!=imgFile.type&&uploadable&&(hMessage("请选择正确的图片格式：jpeg,jpg,png！"),uploadable=!1);var imgSize=imgFile.size/1048576;imgSize>2&&uploadable&&(hMessage("上传图片请限制在2M以内！"),uploadable=!1)}if(uploadable){document.getElementsByClassName("upload-avatar-form")[0].submit(),$scope.uploadAvatarBtn="上传中...";var stop=$interval(function(){var upload_avatar_iframe=window.frames.upload_avatar_iframe.document;if(void 0!=upload_avatar_iframe.getElementsByTagName("pre")[0]){var callback=JSON.parse(upload_avatar_iframe.getElementsByTagName("pre")[0].innerHTML);if(console.log(callback),0==callback.error){var pattern=/^(https|http|www)/g;$rootScope.user.avatar=pattern.test(callback.url)?callback.url:public_path+"/img/avatar/"+callback.url,$scope.uploadAvatarBtn="上传成功！",hMessage("上传成功！"),$interval(function(){$scope.uploadAvatarBtn="上传头像"},2e3)}else hMessage(callback.msg);upload_avatar_iframe.getElementsByTagName("pre")[0].innerHTML="",$interval.cancel(stop)}},checkTime)}},$scope.modifyUserInfo=function(){if($scope.user_name.length<1&&$scope.user_email.length<1)return void hMessage("不能提交空信息，请至少修改一项！");if($scope.user_name.length>0&&!usernameVerify($scope.user_name))return void hMessage("用户名只能以英文字母或中文开头,包含数字，下划线，字母，中文！",3e3);if($scope.user_email.length>0&&!emailVerify($scope.user_email))return void hMessage("请输入正确的邮箱格式！");console.log("username:"+$scope.user_name+",email:"+$scope.user_email);var userInfo={username:$scope.user_name,user_email:$scope.user_email};User.modifyUserInfo(userInfo).success(function(res){console.log(res),0===res.error?($rootScope.user.name=res.user.user_name,$rootScope.username_text='<i class="uk-icon-user"></i> '+res.user.user_name,$rootScope.user.email=res.user.user_email,ipCookie("username",$scope.user_name),hMessage("用户信息修改成功！",2e3),setTimeout(function(){var user_info_modal=UIkit.modal("#modify-userInfo-modal");user_info_modal.hide()},1e3)):hMessage(res.msg,2e3)})}});